<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGLMUI - æ™ºèƒ½ä»»åŠ¡åŠ©æ‰‹</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.11.6/css/layui.css" integrity="sha512-dLA91UJdlyzyfUfYLOEnhXEXpY6U2ESWSSdLIvl85UKNUpXWHxJ+DWTZxVSqP2NIitTpxNPxBqC1JiOqynN1og==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.11.6/layui.js" integrity="sha512-BM5V+9an5QzWfkhrWFJbzkEj0V5glYZWgxY9o7S+c0JGAm6WzN67ZvyzxvTedzgW04QzMU6aSrh5VjCVCd035A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="layui-bg-gray">
    <div class="layui-container" style="width: 100%; max-width: 1200px; padding: 15px;">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="layui-card" style="margin-bottom: 15px;">
            <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0; font-size: 24px; color: #1E9FFF;">
                    <i class="layui-icon layui-icon-voice"></i> AutoGLMUI
                </h1>
              </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="layui-card" style="margin-bottom: 15px;">
            <div class="layui-card-body" style="text-align: center; padding: 15px;">
                <div class="layui-inline">
                    <span class="layui-badge layui-bg-green" id="statusIndicator" style="display: inline-flex; align-items: center; gap: 5px;">
                        <i class="layui-icon layui-icon-ok-circle"></i>
                        <span id="statusText">å·²è¿æ¥</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- ç¤ºä¾‹ä»»åŠ¡æŠ˜å é¢æ¿ -->
        <div class="layui-collapse" lay-accordion style="margin-bottom: 15px;" id="examplesCollapse">
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">
                    <i class="layui-icon layui-icon-template-1"></i> ç¤ºä¾‹ä»»åŠ¡
                    <span class="layui-badge layui-bg-blue" style="float: right; margin-right: 20px;">21ä¸ªç¤ºä¾‹</span>
                </h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-row layui-col-space10" id="examplesList">
                        <!-- ç¤ºä¾‹1 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€å¾®ä¿¡å‘ä¸€æ¡æœ‹å‹åœˆï¼šä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€å¾®ä¿¡å‘ä¸€æ¡æœ‹å‹åœˆï¼šä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹2 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€æŠ–éŸ³æœç´¢çŒ«å’ªè§†é¢‘')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€æŠ–éŸ³æœç´¢çŒ«å’ªè§†é¢‘</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹3 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€æ·˜å®ç»™å¦ˆå¦ˆä¹°ç”Ÿæ—¥ç¤¼ç‰©')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€æ·˜å®ç»™å¦ˆå¦ˆä¹°ç”Ÿæ—¥ç¤¼ç‰©</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹4 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€ç™¾åº¦åœ°å›¾æœç´¢é™„è¿‘ç¾é£Ÿ')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€ç™¾åº¦åœ°å›¾æœç´¢é™„è¿‘ç¾é£Ÿ</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹5 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å‘¨æ°ä¼¦çš„æ­Œ')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å‘¨æ°ä¼¦çš„æ­Œ</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹6 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€çŸ¥ä¹æœç´¢å¦‚ä½•å­¦ä¹ ç¼–ç¨‹')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€çŸ¥ä¹æœç´¢å¦‚ä½•å­¦ä¹ ç¼–ç¨‹</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹7 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€ç¾å›¢æ‰¾é™„è¿‘çš„å’–å•¡å…')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€ç¾å›¢æ‰¾é™„è¿‘çš„å’–å•¡å…</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹8 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€Bç«™æœç´¢ç§‘æŠ€åŒºæœ€æ–°è§†é¢‘')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€Bç«™æœç´¢ç§‘æŠ€åŒºæœ€æ–°è§†é¢‘</span>
                            </button>
                        </div>
                        <!-- æ›´å¤šç¤ºä¾‹é»˜è®¤éšè— -->
                        <!-- ç¤ºä¾‹9 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å»å–œé©¬æ‹‰é›…å¯»æ‰¾å…³äºä¸ªäººæˆé•¿çš„æœ‰å£°ä¹¦ï¼ŒæŒ‘é€‰è¯„ä»·æœ€å¥½çš„ä¸€æœ¬å¼€å§‹æ’­æ”¾')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å»å–œé©¬æ‹‰é›…å¯»æ‰¾å…³äºä¸ªäººæˆé•¿çš„æœ‰å£°ä¹¦ï¼ŒæŒ‘é€‰è¯„ä»·æœ€å¥½çš„ä¸€æœ¬å¼€å§‹æ’­æ”¾</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹10 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('QQéŸ³ä¹æ’­æ”¾ã€Šæ¥è´¢ã€‹')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">QQéŸ³ä¹æ’­æ”¾ã€Šæ¥è´¢ã€‹</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹11 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('ç”¨å€¼å¾—ä¹°çœ‹çœ‹è‚¯å¾·åŸºæœ‰ä»€ä¹ˆä¼˜æƒ ')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">ç”¨å€¼å¾—ä¹°çœ‹çœ‹è‚¯å¾·åŸºæœ‰ä»€ä¹ˆä¼˜æƒ </span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹12 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å¸®æˆ‘åœ¨æºç¨‹æ‰¾ä¸ªå»ä¸œäº¬çš„æ—…è¡Œå›¢')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å¸®æˆ‘åœ¨æºç¨‹æ‰¾ä¸ªå»ä¸œäº¬çš„æ—…è¡Œå›¢</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹13 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å‘ä¸€æ¡å°çº¢ä¹¦è¯´ï¼šè¿™æ˜¯AutoGLMè‡ªåŠ¨å¸®æˆ‘å‘çš„å°çº¢ä¹¦ï¼')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å‘ä¸€æ¡å°çº¢ä¹¦è¯´ï¼šè¿™æ˜¯AutoGLMè‡ªåŠ¨å¸®æˆ‘å‘çš„å°çº¢ä¹¦ï¼</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹14 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å»çº¢æœçŸ­å‰§ä¸Šï¼Œæ’­æ”¾ä¸€ä¸ªé‡ç”Ÿé¢˜æçš„çŸ­å‰§')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å»çº¢æœçŸ­å‰§ä¸Šï¼Œæ’­æ”¾ä¸€ä¸ªé‡ç”Ÿé¢˜æçš„çŸ­å‰§</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹15 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å»å°çº¢ä¹¦å®¢è§‚æ€»ç»“ä¸‹autoglmçš„è¯„ä»·')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å»å°çº¢ä¹¦å®¢è§‚æ€»ç»“ä¸‹autoglmçš„è¯„ä»·</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹16 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('åœ¨æºç¨‹ä¸Šæœç´¢ä¸Šæµ·å¤–æ»©é™„è¿‘çš„äº”æ˜Ÿçº§é…’åº—ï¼Œé¢„è®¢ä¸€é—´æ˜æ™šå…¥ä½çš„å¤§åºŠæˆ¿')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">åœ¨æºç¨‹ä¸Šæœç´¢ä¸Šæµ·å¤–æ»©é™„è¿‘çš„äº”æ˜Ÿçº§é…’åº—ï¼Œé¢„è®¢ä¸€é—´æ˜æ™šå…¥ä½çš„å¤§åºŠæˆ¿</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹17 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('åœ¨å°çº¢ä¹¦æœç´¢åŒ—äº¬æ—…æ¸¸æ”»ç•¥')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">åœ¨å°çº¢ä¹¦æœç´¢åŒ—äº¬æ—…æ¸¸æ”»ç•¥</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹18 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('é¥¿äº†ä¹ˆå¸®æˆ‘è®¢æ¯ç‘å¹¸çš„ç”Ÿæ¤°æ‹¿é“')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">é¥¿äº†ä¹ˆå¸®æˆ‘è®¢æ¯ç‘å¹¸çš„ç”Ÿæ¤°æ‹¿é“</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹19 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å¸®æˆ‘ç”¨é«˜å¾·åœ°å›¾çœ‹ä¸€ä¸‹è·ç¦»äº”é“å£æœ€è¿‘çš„å†œä¸šé“¶è¡Œçš„è¥ä¸šæ—¶é—´')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å¸®æˆ‘ç”¨é«˜å¾·åœ°å›¾çœ‹ä¸€ä¸‹è·ç¦»äº”é“å£æœ€è¿‘çš„å†œä¸šé“¶è¡Œçš„è¥ä¸šæ—¶é—´</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹20 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('è…¾è®¯è§†é¢‘æ’­æ”¾ã€Šæ— ç›¸ä¹‹åŸã€‹ç¬¬2é›†')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">è…¾è®¯è§†é¢‘æ’­æ”¾ã€Šæ— ç›¸ä¹‹åŸã€‹ç¬¬2é›†</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹21 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€å¾®åšæŸ¥çœ‹çƒ­æœæ¦œ')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€å¾®åšæŸ¥çœ‹çƒ­æœæ¦œ</span>
                            </button>
                        </div>
                    </div>
                    <div class="layui-text-center" style="margin-top: 10px;">
                        <button class="layui-btn layui-btn-xs layui-btn-primary" id="loadMoreBtn">
                            <i class="layui-icon layui-icon-down"></i> å±•å¼€æ›´å¤š
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡è¾“å…¥åŒº -->
        <div class="layui-card" style="margin-bottom: 15px;">
            <div class="layui-card-body">
                <form class="layui-form" action="">
                    <div class="layui-form-item layui-form-text">
                        <div class="layui-input-block" style="margin-left: 0;">
                            <textarea id="taskInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ä»»åŠ¡...ï¼ˆæŒ‰ Ctrl+Enter å‘é€ï¼‰"
                                class="layui-textarea" style="min-height: 100px; resize: vertical;"></textarea>
                            <div style="text-align: right; margin-top: 5px; font-size: 12px; color: #999;">
                                <span id="charCount">0</span>/1000
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item" style="text-align: center; margin-bottom: 0;">
                        <button type="button" class="layui-btn" id="sendButton" lay-submit lay-filter="taskForm">
                            <i class="layui-icon layui-icon-release"></i> å‘é€ä»»åŠ¡
                        </button>
                            <button type="button" class="layui-btn layui-btn-warm" id="clearButton">
                            <i class="layui-icon layui-icon-delete"></i> æ¸…ç©ºè®°å½•
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- å“åº”è®°å½• -->
        <div class="layui-card">
            <div class="layui-card-header">
                <span style="font-weight: bold;">
                    <i class="layui-icon layui-icon-file-b"></i> å“åº”è®°å½•
                </span>
                <span class="layui-badge layui-bg-gray" id="responseCount" style="float: right;">0 æ¡è®°å½•</span>
            </div>
            <div class="layui-card-body">
                <div id="responseList" style="max-height: 500px; overflow-y: auto;">
                    <div class="layui-text-center" id="emptyState">
                        <i class="layui-icon layui-icon-face-surprised" style="font-size: 64px; color: #999;"></i>
                        <p style="color: #999; margin-top: 10px;">æš‚æ— å“åº”è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿«æ·é”®æç¤º -->
        <div class="layui-text-center" style="margin-top: 15px; color: #999; font-size: 13px;">
            <span class="layui-badge layui-bg-gray">Ctrl</span> +
            <span class="layui-badge layui-bg-gray">Enter</span>
            å¿«é€Ÿå‘é€ä»»åŠ¡
        </div>

      </div>

    <!-- Toastå®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // å±•å¼€æ›´å¤šç¤ºä¾‹åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            var loadMoreBtn = document.getElementById('loadMoreBtn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var isExpanded = this.innerHTML.includes('æ”¶èµ·ç¤ºä¾‹');
                    var moreExamples = document.querySelectorAll('.more-example');

                    if (isExpanded) {
                        // æ”¶èµ·
                        moreExamples.forEach(function(el) {
                            el.style.display = 'none';
                        });
                        this.innerHTML = '<i class="layui-icon layui-icon-down"></i> å±•å¼€æ›´å¤š';
                    } else {
                        // å±•å¼€
                        moreExamples.forEach(function(el) {
                            el.style.setProperty('display', 'block', 'important');
                        });
                        this.innerHTML = '<i class="layui-icon layui-icon-up"></i> æ”¶èµ·ç¤ºä¾‹';
                    }
                });
            }
        });

        layui.use(['layer', 'form', 'element', 'util'], function(){
            var layer = layui.layer;
            var form = layui.form;
            var element = layui.element;
            var util = layui.util;
            var $ = layui.$;

  
            // é€‰æ‹©ç¤ºä¾‹
            window.selectExample = function(example) {
                $('#taskInput').val(example);
                $('#charCount').text(example.length);
                layer.msg('å·²å¡«å…¥ç¤ºä¾‹ä»»åŠ¡', {icon: 1, time: 1000});
                $('#taskInput').focus();

                // å¦‚æœå½“å‰æ˜¯å±•å¼€çŠ¶æ€ï¼Œè‡ªåŠ¨æ”¶èµ·
                const btn = $('#loadMoreBtn');
                const isExpanded = btn.html().includes('æ”¶èµ·ç¤ºä¾‹');
                if (isExpanded) {
                    setTimeout(function() {
                        $('.more-example').hide();
                        btn.html('<i class="layui-icon layui-icon-down"></i> å±•å¼€æ›´å¤š');
                    }, 200);
                }

                // ç§»åŠ¨ç«¯è‡ªåŠ¨æ”¶èµ·é”®ç›˜
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    $('#taskInput').blur();
                }
            };

        
    
            let taskId = 0;
            let responseCount = 0;

            // æœ¬åœ°å­˜å‚¨ç›¸å…³å‡½æ•°
            function saveToLocalStorage(key, data) {
                try {
                    console.log(`[LocalStorage] å°è¯•ä¿å­˜æ•°æ®åˆ° ${key}:`, { dataLength: JSON.stringify(data).length });
                    const jsonData = JSON.stringify(data);
                    // æ£€æŸ¥å­˜å‚¨ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
                    if (jsonData.length > 5 * 1024 * 1024) { // 5MBé™åˆ¶
                        console.error('æ•°æ®è¿‡å¤§ï¼Œè¶…è¿‡localStorageé™åˆ¶');
                        return false;
                    }
                    localStorage.setItem(key, jsonData);
                    console.log(`[LocalStorage] æˆåŠŸä¿å­˜åˆ° ${key}, å¤§å°:`, (jsonData.length / 1024).toFixed(2) + ' KB');
                    return true;
                } catch (e) {
                    console.error(`[LocalStorage] ä¿å­˜åˆ° ${key} å¤±è´¥:`, e);
                    console.error('é”™è¯¯è¯¦æƒ…:', {
                        name: e.name,
                        message: e.message,
                        stack: e.stack,
                        key: key,
                        dataSize: JSON.stringify(data).length
                    });
                    if (e.name === 'QuotaExceededError') {
                        console.error('localStorageå­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®');
                        // å°è¯•æ¸…ç†ä¸€äº›æ—§æ•°æ®
                        try {
                            const keys = Object.keys(localStorage);
                            for (let key of keys) {
                                if (key.startsWith('taskHistory_')) {
                                    localStorage.removeItem(key);
                                    console.log('å·²æ¸…ç†æ—§æ•°æ®:', key);
                                    break;
                                }
                            }
                            // å†æ¬¡å°è¯•ä¿å­˜
                            localStorage.setItem(key, JSON.stringify(data));
                            return true;
                        } catch (e2) {
                            console.error('æ¸…ç†åä»ç„¶æ— æ³•ä¿å­˜:', e2);
                            return false;
                        }
                    }
                    return false;
                }
            }

            function loadFromLocalStorage(key, defaultValue = null) {
                try {
                    console.log(`[LocalStorage] å°è¯•ä» ${key} åŠ è½½æ•°æ®`);
                    const data = localStorage.getItem(key);
                    if (data) {
                        console.log(`[LocalStorage] ä» ${key} åŠ è½½åˆ°æ•°æ®ï¼Œå¤§å°:`, (data.length / 1024).toFixed(2) + ' KB');
                        return JSON.parse(data);
                    } else {
                        console.log(`[LocalStorage] ${key} ä¸­æ²¡æœ‰æ•°æ®ï¼Œè¿”å›é»˜è®¤å€¼`);
                        return defaultValue;
                    }
                } catch (e) {
                    console.error(`[LocalStorage] ä» ${key} åŠ è½½å¤±è´¥:`, e);
                    return defaultValue;
                }
            }

            // ä¿å­˜ä»»åŠ¡å†å²
            function saveTaskHistory(taskData) {
                try {
                    let history = loadFromLocalStorage('taskHistory', []);
                    history.unshift(taskData); // æ·»åŠ åˆ°å¼€å¤´
                    // åªä¿ç•™æœ€è¿‘100æ¡
                    if (history.length > 100) {
                        history = history.slice(0, 100);
                    }
                    const success = saveToLocalStorage('taskHistory', history);
                    if (success) {
                        console.log('å†å²è®°å½•å·²ä¿å­˜ï¼Œå½“å‰æ€»æ•°:', history.length);
                        updateHistoryCount();
                        return true;
                    } else {
                        console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥');
                        return false;
                    }
                } catch (e) {
                    console.error('ä¿å­˜ä»»åŠ¡å†å²æ—¶å‡ºé”™:', e);
                    return false;
                }
            }

            // åŠ è½½ä»»åŠ¡å†å²
            function loadTaskHistory() {
                return loadFromLocalStorage('taskHistory', []);
            }

            // å‹ç¼©å“åº”å†…å®¹ä»¥èŠ‚çœç©ºé—´
            function compressResponseContent(html) {
                try {
                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„divæ¥è§£æHTML
                    const temp = document.createElement('div');
                    temp.innerHTML = html;

                    // ç§»é™¤ä¸å¿…è¦çš„å±æ€§å’Œå…ƒç´ ä»¥èŠ‚çœç©ºé—´
                    // 1. ç§»é™¤progresså…ƒç´ 
                    const progressElements = temp.querySelectorAll('.layui-progress');
                    progressElements.forEach(el => el.remove());

                    // 2. ç§»é™¤loadingåŠ¨ç”»
                    const loadingIcons = temp.querySelectorAll('.layui-icon-loading');
                    loadingIcons.forEach(el => {
                        el.classList.remove('layui-anim', 'layui-anim-rotate', 'layui-anim-loop');
                    });

                    // 3. ç®€åŒ–classå±æ€§
                    const allElements = temp.querySelectorAll('*');
                    allElements.forEach(el => {
                        // åªä¿ç•™å¿…è¦çš„class
                        if (el.className) {
                            const classes = el.className.split(' ').filter(cls =>
                                cls.startsWith('response-') ||
                                cls === 'response-content' ||
                                cls === 'status-text'
                            );
                            el.className = classes.join(' ');
                        }
                    });

                    // 4. ç§»é™¤dataå±æ€§
                    allElements.forEach(el => {
                        const attrs = Array.from(el.attributes);
                        attrs.forEach(attr => {
                            if (attr.name.startsWith('data-')) {
                                el.removeAttribute(attr.name);
                            }
                        });
                    });

                    return temp.innerHTML;
                } catch (e) {
                    console.error('å‹ç¼©å“åº”å†…å®¹å¤±è´¥:', e);
                    return html; // è¿”å›åŸå§‹HTML
                }
            }

        // æ£€æŸ¥localStorageä½¿ç”¨æƒ…å†µ
            function checkLocalStorageUsage() {
                try {
                    let total = 0;
                    let taskHistorySize = 0;

                    // è®¡ç®—æ€»ä½¿ç”¨é‡
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            const size = localStorage[key].length;
                            total += size;
                            if (key === 'taskHistory') {
                                taskHistorySize = size;
                            }
                        }
                    }

                    // localStorageé€šå¸¸æœ‰5MBé™åˆ¶
                    const limit = 5 * 1024 * 1024;
                    const usagePercent = (total / limit * 100).toFixed(2);

                    console.log('localStorageä½¿ç”¨æƒ…å†µ:');
                    console.log(`- æ€»ä½¿ç”¨é‡: ${(total / 1024).toFixed(2)} KB (${usagePercent}%)`);
                    console.log(`- taskHistoryå¤§å°: ${(taskHistorySize / 1024).toFixed(2)} KB`);
                    console.log(`- å†å²è®°å½•æ•°é‡: ${loadFromLocalStorage('taskHistory', []).length}`);

                    return {
                        total: total,
                        limit: limit,
                        usagePercent: usagePercent,
                        taskHistorySize: taskHistorySize
                    };
                } catch (e) {
                    console.error('æ£€æŸ¥localStorageä½¿ç”¨æƒ…å†µå¤±è´¥:', e);
                    return null;
                }
            }

            // æ–‡æœ¬æ¡†å­—ç¬¦è®¡æ•°
            $('#taskInput').on('input', function(){
                const length = $(this).val().length;
                $('#charCount').text(length);
                if (length > 1000) {
                    $(this).val($(this).val().substring(0, 1000));
                    $('#charCount').text(1000);
                }
            });

            // å‘é€ä»»åŠ¡
            window.sendTask = function() {
                const task = $('#taskInput').val().trim();
                if (!task) {
                    layer.msg('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹', {icon: 2});
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½
                const loadIndex = layer.load(2, {shade: [0.1, '#fff']});

                // åˆ›å»ºæ–°çš„å“åº”é¡¹
                const responseList = $('#responseList');
                const emptyState = $('#emptyState');

                if (responseCount === 0) {
                    responseList.empty();
                    responseList.addClass('layui-timeline');
                }

                const time = util.toDateString(new Date(), 'yyyy-MM-dd HH:mm:ss');
                const responseId = ++taskId;
                console.log(`[SendTask] åˆ›å»ºæ–°ä»»åŠ¡ï¼ŒresponseId: ${responseId}, task: ${task.substring(0, 50)}...`);

                const responseItem = $(`
                    <div class="layui-timeline-item" style="padding-bottom: 20px;">
                        <i class="layui-icon layui-timeline-axis layui-icon-loading-1" style="color: #1E9FFF;"></i>
                        <div class="layui-timeline-content layui-text">
                            <div class="layui-card">
                                <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleTaskDetails(${responseId})">
                                    <span class="layui-badge layui-bg-blue" style="font-size: 12px;">ä»»åŠ¡ #${responseId}</span>
                                    <span style="color: #999; font-size: 12px;">${time} <i class="layui-icon layui-icon-up" id="toggle-icon-${responseId}" style="margin-left: 5px;"></i></span>
                                </div>
                                <div class="layui-card-body">
                                    <blockquote class="layui-elem-quote" style="margin-bottom: 10px;">
                                        <strong>ä»»åŠ¡:</strong> ${task}
                                    </blockquote>
                                    <div id="streaming-${responseId}" style="color: #666; line-height: 1.6;">
                                        <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="progress-${responseId}">
                                            <div class="layui-progress-bar" lay-percent="0%"></div>
                                        </div>
                                        <div style="margin-top: 10px; font-size: 14px; color: #999;">
                                            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> ç­‰å¾…å“åº”...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);

                responseItem.attr('data-task-id', responseId);
                responseItem.data('task', task);
                responseList.prepend(responseItem);
                emptyState.hide();
                responseCount++;
                updateResponseCount();

                // åˆå§‹åŒ–è¿›åº¦æ¡
                element.render('progress');

                // ä½¿ç”¨ HTTP Streaming
                fetch('/api/send-task-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ task: task })
                }).then(response => {
                    layer.close(loadIndex);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let progress = 0;
                    let buffer = '';

                    function processStream() {
                        return reader.read().then(({ done, value }) => {
                            if (done) {
                                // æµç»“æŸ - åŒ…è£…å†…å®¹ä»¥ä¾¿æŠ˜å 
                                const container = document.querySelector(`#streaming-${responseId}`);
                                const existingContent = container.innerHTML;

                                // åˆ›å»ºä»»åŠ¡è¯¦æƒ…åŒ…è£…å™¨
                                const taskDetailsDiv = document.createElement('div');
                                taskDetailsDiv.className = 'task-details-wrapper';
                                taskDetailsDiv.innerHTML = existingContent;

                                // æ·»åŠ å®ŒæˆçŠ¶æ€
                                const completeStatus = document.createElement('div');
                                completeStatus.style.marginTop = '10px';
                                completeStatus.style.fontSize = '14px';
                                completeStatus.style.color = '#5FB878';
                                completeStatus.innerHTML = '<i class="layui-icon layui-icon-ok-circle"></i> ä»»åŠ¡å®Œæˆ';

                                // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°å†…å®¹
                                container.innerHTML = '';
                                container.appendChild(taskDetailsDiv);
                                container.appendChild(completeStatus);

                                console.log('[Streaming] æµç»“æŸï¼Œä»»åŠ¡å·²å®Œæˆ');
                                return;
                            }

                            // è§£ç æ–°çš„æ•°æ®å—
                            const chunk = decoder.decode(value, { stream: true });
                            buffer += chunk;

                            // æŒ‰è¡Œåˆ†å‰²æ•°æ®
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„è¡Œ

                            // å¤„ç†æ¯ä¸€è¡Œ
                            lines.forEach(line => {
                                if (line.trim()) {
                                    try {
                                        const data = JSON.parse(line);
                                        handleStreamingData(responseId, data, progress);

                                        // æ›´æ–°è¿›åº¦
                                        if (data.type === 'response') {
                                            progress = Math.min(progress + 10, 90);
                                            element.progress('progress-' + responseId, progress + '%');
                                        }
                                    } catch (e) {
                                        console.error('Error parsing streaming data:', e, 'Raw data:', line);
                                    }
                                }
                            });

                            return processStream();
                        });
                    }

                    return processStream();
                }).catch(error => {
                    layer.close(loadIndex);
                    console.error('Streaming error:', error);
                    const container = document.querySelector(`#streaming-${responseId}`);
                    container.innerHTML = `
                        <div style="color: #FF5722; font-size: 14px;">
                            <i class="layui-icon layui-icon-close-fill"></i> é”™è¯¯: ${error.message}
                        </div>
                    `;

                    // å³ä½¿å‡ºé”™ä¹Ÿä¿å­˜ä»»åŠ¡åˆ°å†å²è®°å½•
                    const responseItem = $(`[data-task-id="${responseId}"]`);
                    if (responseItem.length) {
                        const taskData = {
                            id: responseId,
                            task: responseItem.data('task'),
                            timestamp: new Date().getTime(),
                            responseContent: compressResponseContent(container.innerHTML)
                        };
                        saveTaskHistory(taskData);
                    }
                });

                $('#taskInput').val('');
                $('#charCount').text('0');
            };

            // å¤„ç† streaming æ•°æ®
            function handleStreamingData(responseId, data, progress) {
                console.log(`[handleStreamingData] æ”¶åˆ°æ•°æ®ï¼ŒresponseId: ${responseId}, type: ${data.type}`);
                const container = document.querySelector(`#streaming-${responseId}`);
                if (!container) {
                    console.warn(`[handleStreamingData] æœªæ‰¾åˆ°å®¹å™¨ #streaming-${responseId}`);
                    return;
                }

                if (data.type === 'sent') {
                    container.innerHTML = `
                        <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="progress-${responseId}">
                            <div class="layui-progress-bar" lay-percent="0%"></div>
                        </div>
                        <div style="margin-top: 10px; font-size: 14px; color: #999;">
                            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> ä»»åŠ¡å·²å‘é€ï¼Œç­‰å¾…å“åº”...
                        </div>
                    `;
                    element.render('progress');
                } else if (data.type === 'response') {
                    const msgType = data.data.msg_type || 'unknown';
                    const parsedData = data.data.parsed_data;

                    // åˆ›å»ºæˆ–è·å–å“åº”å†…å®¹å®¹å™¨
                    const responseDiv = container.querySelector('.response-content') || document.createElement('div');
                    responseDiv.className = 'response-content';
                    responseDiv.style.marginTop = '10px';
                    responseDiv.style.padding = '10px';
                    responseDiv.style.backgroundColor = '#f8f8f8';
                    responseDiv.style.borderRadius = '4px';
                    responseDiv.style.fontSize = '14px';
                    responseDiv.style.whiteSpace = 'pre-wrap';
                    responseDiv.style.maxHeight = '400px';
                    responseDiv.style.overflowY = 'auto';

                    // æ ¹æ®æ¶ˆæ¯ç±»å‹æ ¼å¼åŒ–æ˜¾ç¤º
                    let displayContent = '';
                    const timestamp = new Date(data.data.timestamp).toLocaleTimeString();

                    if (msgType === 'server_init') {
                        displayContent = `[${timestamp}] ğŸ”§ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ\n`;
                    } else if (msgType === 'server_session') {
                        displayContent = `[${timestamp}] ğŸ”’ ä¼šè¯å·²å»ºç«‹\n`;
                    } else if (msgType === 'agent_response') {
                        const content = parsedData?.data?.content || parsedData?.content || 'ä»£ç†å“åº”';
                        displayContent = `[${timestamp}] ğŸ¤– ä»£ç†å“åº”:\n${content}\n\n`;
                    } else if (msgType === 'task_result') {
                        const result = parsedData?.data?.result || parsedData?.result || 'ä»»åŠ¡å®Œæˆ';
                        displayContent = `[${timestamp}] âœ… ä»»åŠ¡ç»“æœ:\n${result}\n\n`;
                    } else if (msgType === 'task_status') {
                        const status = parsedData?.data?.status || 'çŠ¶æ€æ›´æ–°';
                        displayContent = `[${timestamp}] ğŸ“Š ä»»åŠ¡çŠ¶æ€: ${status}\n`;
                    } else if (msgType === 'error') {
                        const errorMsg = parsedData?.data?.error || parsedData?.error || 'å‘ç”Ÿé”™è¯¯';
                        displayContent = `[${timestamp}] âŒ é”™è¯¯: ${errorMsg}\n`;
                    } else {
                        // æ˜¾ç¤ºåŸå§‹æ¶ˆæ¯æˆ–è§£æåçš„å†…å®¹
                        const message = parsedData?.data?.message || parsedData?.message || data.data.message;
                        if (message) {
                            displayContent = `[${timestamp}] ğŸ“¨ ${message}\n\n`;
                        }
                    }

                    // è¿½åŠ åˆ°ç°æœ‰å†…å®¹
                    if (displayContent) {
                        responseDiv.textContent += displayContent;
                    }

                    if (!container.querySelector('.response-content')) {
                        container.appendChild(responseDiv);
                    }

                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    responseDiv.scrollTop = responseDiv.scrollHeight;

                    // å®æ—¶ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆæ›´æ–°å·²æœ‰è®°å½•ï¼‰
                    const responseItem = $(`[data-task-id="${responseId}"]`);
                    if (responseItem.length) {
                        const taskData = {
                            id: responseId,
                            task: responseItem.data('task'),
                            timestamp: new Date().getTime(),
                            responseContent: compressResponseContent(container.innerHTML)
                        };
                        console.log('[Streaming Update] æ­£åœ¨æ›´æ–°å†å²è®°å½•ï¼ŒresponseId:', responseId);
                        let history = loadFromLocalStorage('taskHistory', []);
                        console.log('[Streaming Update] å½“å‰å†å²è®°å½•æ•°é‡:', history.length);
                        // æ›´æ–°æˆ–æ·»åŠ è®°å½•
                        const existingIndex = history.findIndex(h => h.id === responseId);
                        if (existingIndex >= 0) {
                            console.log('[Streaming Update] æ›´æ–°ç°æœ‰è®°å½•');
                            history[existingIndex] = taskData;
                        } else {
                            console.log('[Streaming Update] æ·»åŠ æ–°è®°å½•');
                            history.unshift(taskData);
                        }
                        // åªä¿ç•™æœ€è¿‘100æ¡
                        if (history.length > 100) {
                            history = history.slice(0, 100);
                        }
                        console.log('[Streaming Update] ä¿å­˜åå†å²è®°å½•æ•°é‡:', history.length);
                        saveToLocalStorage('taskHistory', history);
                    }
                } else if (data.type === 'error') {
                    container.innerHTML = `
                        <div style="color: #FF5722; font-size: 14px;">
                            <i class="layui-icon layui-icon-close-fill"></i> é”™è¯¯: ${data.message}
                        </div>
                    `;
                } else if (data.type === 'complete') {
                    element.progress('progress-' + responseId, '100%');

                    // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
                    const progressBar = container.querySelector('.layui-progress');
                    if (progressBar) {
                        progressBar.style.display = 'none';
                    }

                    // æ›´æ–°çŠ¶æ€å›¾æ ‡
                    const statusIcon = container.querySelector('.layui-icon-loading');
                    if (statusIcon) {
                        statusIcon.className = 'layui-icon layui-icon-ok-circle';
                        statusIcon.style.color = '#5FB878';
                        statusIcon.classList.remove('layui-anim', 'layui-anim-rotate', 'layui-anim-loop');
                    }

                    // æ·»åŠ å®Œæˆä¿¡æ¯
                    const completeMsg = data.response_count ?
                        `ä»»åŠ¡å®Œæˆ (å…±æ”¶åˆ° ${data.response_count} æ¡å“åº”)` :
                        'ä»»åŠ¡å®Œæˆ';

                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»»åŠ¡è¯¦æƒ…åŒ…è£…å™¨
                    let taskDetailsWrapper = container.querySelector('.task-details-wrapper');
                    if (!taskDetailsWrapper) {
                        taskDetailsWrapper = document.createElement('div');
                        taskDetailsWrapper.className = 'task-details-wrapper';

                        // å°†ç°æœ‰å†…å®¹ç§»åˆ°åŒ…è£…å™¨ä¸­ï¼ˆé™¤äº†çŠ¶æ€æ–‡æœ¬ï¼‰
                        const existingContent = container.innerHTML;
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = existingContent;
                        const statusDivs = tempDiv.querySelectorAll('.status-text');
                        statusDivs.forEach(div => div.remove());

                        taskDetailsWrapper.innerHTML = tempDiv.innerHTML;

                        // æ¸…ç©ºå®¹å™¨å¹¶é‡æ–°ç»„ç»‡
                        container.innerHTML = '';
                        container.appendChild(taskDetailsWrapper);
                    }

                    // æ·»åŠ æˆ–æ›´æ–°çŠ¶æ€æ–‡æœ¬
                    const statusDiv = container.querySelector('.status-text') || document.createElement('div');
                    statusDiv.className = 'status-text';
                    statusDiv.style.marginTop = '10px';
                    statusDiv.style.fontSize = '14px';
                    statusDiv.style.color = '#5FB878';
                    statusDiv.innerHTML = `<i class="layui-icon layui-icon-ok-circle"></i> ${completeMsg}`;

                    if (!container.querySelector('.status-text')) {
                        container.appendChild(statusDiv);
                    }

    
                    // æ›´æ–°ä»»åŠ¡å®ŒæˆçŠ¶æ€ï¼Œä½†ä¸éœ€è¦å†æ¬¡ä¿å­˜ï¼ˆå› ä¸ºåœ¨handleStreamingDataä¸­å·²ç»å®æ—¶ä¿å­˜äº†ï¼‰
                    console.log('[Streaming] ä»»åŠ¡å®Œæˆï¼ŒresponseId:', responseId);
                    console.log('[Streaming] ä»»åŠ¡å·²é€šè¿‡å®æ—¶æ›´æ–°ä¿å­˜ï¼Œæ— éœ€å†æ¬¡ä¿å­˜');
                }
            }

            // æ˜¾ç¤ºå“åº”
            function showResponse(task, response, timestamp) {
                const responseList = $('#responseList');
                const emptyState = $('#emptyState');

                const isSuccess = response.includes('ä»»åŠ¡å·²å‘é€');
                const statusClass = isSuccess ? 'layui-badge layui-bg-green' : 'layui-badge layui-bg-red';
                const statusIcon = isSuccess ? 'layui-icon-ok-circle' : 'layui-icon-close-fill';

                const time = util.toDateString(new Date(timestamp), 'yyyy-MM-dd HH:mm:ss');
                const responseId = ++taskId;

                const responseItem = $(`
                    <div class="layui-timeline-item" style="padding-bottom: 20px;">
                        <i class="layui-icon layui-timeline-axis ${statusIcon}" style="color: ${isSuccess ? '#5FB878' : '#FF5722'};"></i>
                        <div class="layui-timeline-content layui-text">
                            <div class="layui-card">
                                <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleTaskDetails(${responseId})">
                                    <span class="${statusClass}" style="font-size: 12px;">ä»»åŠ¡ #${responseId}</span>
                                    <span style="color: #999; font-size: 12px;">${time} <i class="layui-icon layui-icon-up" id="toggle-icon-${responseId}" style="margin-left: 5px;"></i></span>
                                </div>
                                <div class="layui-card-body">
                                    <blockquote class="layui-elem-quote" style="margin-bottom: 10px;">
                                        <strong>ä»»åŠ¡:</strong> ${task}
                                    </blockquote>
                                    <div style="color: #666; line-height: 1.6;">
                                        ${response}
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="copyResponse(${responseId})">
                                            <i class="layui-icon layui-icon-file"></i> å¤åˆ¶
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);

                responseItem.attr('data-task-id', responseId);
                responseItem.data('task', task);
                responseItem.data('response', response);

                if (responseCount === 0) {
                    responseList.empty();
                    responseList.addClass('layui-timeline');
                }

                responseList.prepend(responseItem);
                emptyState.hide();

                responseCount++;
                updateResponseCount();
            }

            // å¤åˆ¶å“åº”
            window.copyResponse = function(id) {
                const responseItem = $(`[data-task-id="${id}"]`);
                if (responseItem.length) {
                    const task = responseItem.data('task');
                    const response = responseItem.data('response');
                    const text = `ä»»åŠ¡: ${task}\nå“åº”: ${response}`;

                    navigator.clipboard.writeText(text).then(function() {
                        layer.msg('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', {icon: 1});
                    }).catch(function() {
                        layer.msg('å¤åˆ¶å¤±è´¥', {icon: 2});
                    });
                }
            };

            // åˆ‡æ¢ä»»åŠ¡è¯¦æƒ…æ˜¾ç¤º/éšè—
            window.toggleTaskDetails = function(taskId) {
                const container = document.querySelector(`#streaming-${taskId}`);
                if (!container) return;

                // æŸ¥æ‰¾ä»»åŠ¡è¯¦æƒ…å…ƒç´ 
                let taskDetailsWrapper = container.querySelector('.task-details-wrapper');
                let taskDetails = container.querySelector('.task-details');
                const toggleIcon = document.querySelector(`#toggle-icon-${taskId}`);

                // å¦‚æœæ²¡æœ‰æ‰¾åˆ° .task-details-wrapperï¼Œåˆ™ä½¿ç”¨ .task-details
                if (!taskDetailsWrapper && taskDetails) {
                    taskDetailsWrapper = taskDetails;
                } else if (!taskDetailsWrapper && !taskDetails) {
                    // å¦‚æœéƒ½æ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨æ•´ä¸ª containerï¼ˆé™¤äº†æœ€åä¸€ä¸ªå­å…ƒç´ ï¼‰
                    const children = Array.from(container.children);
                    if (children.length > 1) {
                        // åˆ›å»ºåŒ…è£…å™¨
                        taskDetailsWrapper = document.createElement('div');
                        taskDetailsWrapper.className = 'task-details-wrapper';
                        // å°†é™¤äº†æœ€åä¸€ä¸ªå…ƒç´ å¤–çš„æ‰€æœ‰å­å…ƒç´ ç§»åˆ°åŒ…è£…å™¨ä¸­
                        children.slice(0, -1).forEach(child => {
                            taskDetailsWrapper.appendChild(child);
                        });
                        container.insertBefore(taskDetailsWrapper, container.lastElementChild);
                    }
                }

                if (taskDetailsWrapper) {
                    if (taskDetailsWrapper.style.display === 'none') {
                        // å±•å¼€è¯¦æƒ…
                        taskDetailsWrapper.style.display = 'block';
                        if (toggleIcon) {
                            toggleIcon.className = 'layui-icon layui-icon-up';
                        }
                    } else {
                        // æ”¶èµ·è¯¦æƒ…
                        taskDetailsWrapper.style.display = 'none';
                        if (toggleIcon) {
                            toggleIcon.className = 'layui-icon layui-icon-down';
                        }
                    }
                }
            };

            // æ¸…ç©ºå“åº”
            window.clearResponses = function() {
                if (responseCount === 0) {
                    layer.msg('æ²¡æœ‰è®°å½•éœ€è¦æ¸…ç©º', {icon: 0});
                    return;
                }

                layer.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å“åº”è®°å½•å—ï¼Ÿ', {icon: 3, title: 'æç¤º'}, function(index){
                    $('#responseList').empty().removeClass('layui-timeline');
                    $('#emptyState').show();
                    responseCount = 0;
                    taskId = 0;
                    updateResponseCount();
                    // åŒæ—¶æ¸…ç©ºæœ¬åœ°å­˜å‚¨
                    localStorage.removeItem('taskHistory');
                    updateHistoryCount();
                    layer.close(index);
                    layer.msg('å·²æ¸…ç©ºæ‰€æœ‰è®°å½•', {icon: 1});
                });
            };

            // æ›´æ–°å“åº”è®¡æ•°
            function updateResponseCount() {
                $('#responseCount').text(`${responseCount} æ¡è®°å½•`);
            }

            // æ›´æ–°å†å²è®°å½•è®¡æ•°
            function updateHistoryCount() {
                const history = loadTaskHistory();
                $('#historyCount').text(`å†å²è®°å½•: ${history.length} æ¡`);
            }

            // æ˜¾ç¤ºå†å²è®°å½•å¼¹çª—ï¼ˆå·²ç§»é™¤æŒ‰é’®ï¼Œä½†ä¿ç•™å‡½æ•°ä»¥ä¾›è°ƒè¯•ä½¿ç”¨ï¼‰
            window.showHistory = function() {
                const history = loadTaskHistory();
                console.log('åŠ è½½çš„å†å²è®°å½•:', history); // è°ƒè¯•æ—¥å¿—
                let historyHtml = '';

                if (history.length === 0) {
                    historyHtml = '<div class="layui-text-center" style="padding: 20px;"><i class="layui-icon layui-icon-face-surprised" style="font-size: 48px; color: #999;"></i><p style="color: #999; margin-top: 10px;">æš‚æ— å†å²è®°å½•</p><p style="color: #999; font-size: 12px;">æç¤ºï¼šè¯·å…ˆå‘é€ä¸€äº›ä»»åŠ¡</p></div>';
                } else {
                    historyHtml = '<div class="layui-timeline" style="max-height: 500px; overflow-y: auto; padding: 20px;">';
                    history.forEach(item => {
                        const time = util.toDateString(new Date(item.timestamp), 'yyyy-MM-dd HH:mm:ss');
                        historyHtml += `
                            <div class="layui-timeline-item">
                                <i class="layui-icon layui-timeline-axis layui-icon-ok-circle" style="color: #5FB878;"></i>
                                <div class="layui-timeline-content layui-text">
                                    <div class="layui-card">
                                        <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                            <span class="layui-badge layui-bg-green" style="font-size: 12px;">ä»»åŠ¡ #${item.id}</span>
                                            <span style="color: #999; font-size: 12px;">${time}</span>
                                        </div>
                                        <div class="layui-card-body">
                                            <blockquote class="layui-elem-quote" style="margin-bottom: 10px;">
                                                <strong>ä»»åŠ¡:</strong> ${item.task}
                                            </blockquote>
                                            <div style="margin-bottom: 10px;">
                                                <button class="layui-btn layui-btn-xs layui-btn-normal" onclick="reuseTask('${item.task.replace(/'/g, "\\'")}')">
                                                    <i class="layui-icon layui-icon-refresh"></i> å¤ç”¨ä»»åŠ¡
                                                </button>
                                                <button class="layui-btn layui-btn-xs layui-btn-danger" onclick="deleteHistoryItem(${item.timestamp})">
                                                    <i class="layui-icon layui-icon-delete"></i> åˆ é™¤
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    historyHtml += '</div>';
                }

                layer.open({
                    type: 1,
                    title: 'å†å²è®°å½•',
                    area: ['80%', '80%'],
                    maxmin: true,
                    content: historyHtml,
                    btn: ['æ¸…ç©ºæ‰€æœ‰å†å²', 'å…³é—­'],
                    btn1: function(index) {
                        layer.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ', {icon: 3, title: 'æç¤º'}, function(i){
                            localStorage.removeItem('taskHistory');
                            layer.close(i);
                            layer.close(index);
                            layer.msg('å†å²è®°å½•å·²æ¸…ç©º', {icon: 1});
                            // åˆ·æ–°é¡µé¢æ˜¾ç¤º
                            location.reload();
                        });
                    },
                    btn2: function(index) {
                        layer.close(index);
                        updateHistoryCount();
                    }
                });
            };

            // å¤ç”¨ä»»åŠ¡
            window.reuseTask = function(task) {
                $('#taskInput').val(task);
                $('#charCount').text(task.length);
                layer.closeAll('page');
                layer.msg('ä»»åŠ¡å·²å¡«å…¥', {icon: 1});
                $('#taskInput').focus();
            };

            // åˆ é™¤å•ä¸ªå†å²è®°å½•
            window.deleteHistoryItem = function(timestamp) {
                layer.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', {icon: 3, title: 'æç¤º'}, function(index){
                    let history = loadTaskHistory();
                    history = history.filter(item => item.timestamp !== timestamp);
                    saveToLocalStorage('taskHistory', history);
                    updateHistoryCount();
                    layer.close(index);
                    layer.msg('è®°å½•å·²åˆ é™¤', {icon: 1});
                    // åˆ·æ–°å†å²è®°å½•çª—å£
                    layer.closeAll('page');
                    showHistory();
                });
            };

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            $('#sendButton').on('click', sendTask);
            $('#clearButton').on('click', clearResponses);

            // Ctrl+Enter å‘é€
            $('#taskInput').on('keydown', function(e){
                if (e.ctrlKey && e.keyCode === 13) {
                    e.preventDefault();
                    sendTask();
                }
            });

            // è‡ªåŠ¨æ›´æ–°çŠ¶æ€
            function updateStatus() {
                $.get('/api/status', function(data){
                    const statusIndicator = $('#statusIndicator');
                    const statusText = $('#statusText');

                    if (data.connected) {
                        statusIndicator.removeClass('layui-bg-red').addClass('layui-bg-green');
                        statusIndicator.html('<i class="layui-icon layui-icon-ok-circle"></i> <span>å·²è¿æ¥</span>');
                    } else {
                        statusIndicator.removeClass('layui-bg-green').addClass('layui-bg-red');
                        statusIndicator.html('<i class="layui-icon layui-icon-close-fill"></i> <span>æœªè¿æ¥</span>');
                    }
                }).fail(function(){
                    const statusIndicator = $('#statusIndicator');
                    statusIndicator.removeClass('layui-bg-green').addClass('layui-bg-red');
                    statusIndicator.html('<i class="layui-icon layui-icon-close-fill"></i> <span>æœªè¿æ¥</span>');
                });
            }

            // é¡µé¢åŠ è½½æ—¶æ¢å¤å†å²è®°å½•
            function loadHistoryOnPageLoad() {
                const history = loadTaskHistory();
                console.log('é¡µé¢åŠ è½½æ—¶å‘ç°çš„å†å²è®°å½•æ•°é‡:', history.length); // è°ƒè¯•æ—¥å¿—
                const responseList = $('#responseList');
                const emptyState = $('#emptyState');

                if (history.length > 0) {
                    responseList.empty();
                    responseList.addClass('layui-timeline');
                    emptyState.hide();

                    history.forEach(item => {
                        const time = util.toDateString(new Date(item.timestamp), 'yyyy-MM-dd HH:mm:ss');
                        const responseItem = $(`
                            <div class="layui-timeline-item" style="padding-bottom: 20px;">
                                <i class="layui-icon layui-timeline-axis layui-icon-ok-circle" style="color: #5FB878;"></i>
                                <div class="layui-timeline-content layui-text">
                                    <div class="layui-card">
                                        <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleTaskDetails(${item.id})">
                                            <span class="layui-badge layui-bg-green" style="font-size: 12px;">ä»»åŠ¡ #${item.id}</span>
                                            <span style="color: #999; font-size: 12px;">${time} <i class="layui-icon layui-icon-up" id="toggle-icon-${item.id}" style="margin-left: 5px;"></i></span>
                                        </div>
                                        <div class="layui-card-body">
                                            <blockquote class="layui-elem-quote" style="margin-bottom: 10px;">
                                                <strong>ä»»åŠ¡:</strong> ${item.task}
                                            </blockquote>
                                            <div id="streaming-${item.id}" style="color: #666; line-height: 1.6;">
                                                <div class="task-details-wrapper">
                                                    ${item.responseContent}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);

                        responseItem.attr('data-task-id', item.id);
                        responseItem.data('task', item.task);
                        responseList.append(responseItem);
                    });

                    responseCount = history.length;
                    taskId = Math.max(...history.map(h => h.id), 0);
                    updateResponseCount();
                }
            }

            // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
            loadHistoryOnPageLoad();

            // æ£€æŸ¥localStorageä½¿ç”¨æƒ…å†µï¼ˆç”¨äºè°ƒè¯•ï¼‰
            setTimeout(() => {
                console.log('=== localStorageè°ƒè¯•ä¿¡æ¯ ===');
                const usage = checkLocalStorageUsage();
                if (usage) {
                    console.log('localStorageç©ºé—´æ£€æŸ¥æ­£å¸¸');
                } else {
                    console.error('localStorageç©ºé—´æ£€æŸ¥å¼‚å¸¸');
                }

                // æµ‹è¯•åŸºæœ¬åŠŸèƒ½
                const basicTest = window.debugLocalStorage.testBasic();
                if (!basicTest) {
                    console.error('localStorageåŸºæœ¬åŠŸèƒ½æµ‹è¯•å¤±è´¥ï¼');
                }

                // æ˜¾ç¤ºæ‰€æœ‰é”®
                window.debugLocalStorage.showAllKeys();
            }, 1000);

            // æ·»åŠ è°ƒè¯•å·¥å…·åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.debugLocalStorage = {
                checkUsage: checkLocalStorageUsage,
                clearHistory: function() {
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ\nè¿™å°†åŒæ—¶æ¸…ç©ºé¡µé¢ä¸Šçš„æ‰€æœ‰æ˜¾ç¤ºè®°å½•ã€‚')) {
                        localStorage.removeItem('taskHistory');
                        console.log('å†å²è®°å½•å·²æ¸…ç©º');
                        // åŒæ—¶æ¸…ç©ºé¡µé¢ä¸Šçš„æ˜¾ç¤º
                        $('#responseList').empty().removeClass('layui-timeline');
                        $('#emptyState').show();
                        responseCount = 0;
                        taskId = 0;
                        updateHistoryCount();
                        console.log('é¡µé¢æ˜¾ç¤ºå·²æ¸…ç©º');
                    }
                },
                showHistory: function() {
                    const history = loadFromLocalStorage('taskHistory', []);
                    console.log('å½“å‰å†å²è®°å½•:', history);
                    return history;
                },
                testSave: function() {
                    const testData = { id: Date.now(), task: 'æµ‹è¯•ä»»åŠ¡', timestamp: Date.now(), responseContent: '<div>æµ‹è¯•å†…å®¹</div>' };
                    const result = saveTaskHistory(testData);
                    console.log('æµ‹è¯•ä¿å­˜ç»“æœ:', result);
                    return result;
                },
                testBasic: function() {
                    console.log('=== æµ‹è¯•localStorageåŸºæœ¬åŠŸèƒ½ ===');
                    try {
                        // æµ‹è¯•å†™å…¥
                        localStorage.setItem('test_key', 'test_value');
                        const value = localStorage.getItem('test_key');
                        if (value === 'test_value') {
                            console.log('âœ“ localStorageåŸºæœ¬åŠŸèƒ½æ­£å¸¸');
                            localStorage.removeItem('test_key');
                            return true;
                        } else {
                            console.error('âœ— localStorageè¯»å–å€¼ä¸åŒ¹é…');
                            return false;
                        }
                    } catch (e) {
                        console.error('âœ— localStorageåŸºæœ¬åŠŸèƒ½å¼‚å¸¸:', e);
                        return false;
                    }
                },
                showAllKeys: function() {
                    console.log('=== localStorageä¸­çš„æ‰€æœ‰é”® ===');
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        const size = localStorage[key].length;
                        console.log(`- ${key}: ${(size / 1024).toFixed(2)} KB`);
                    });
                    return keys;
                }
            };

            console.log('localStorageè°ƒè¯•å·¥å…·å·²æ·»åŠ åˆ° window.debugLocalStorage');

            // æ¯5ç§’æ›´æ–°çŠ¶æ€
            setInterval(updateStatus, 5000);
            updateStatus();

            // å“åº”å¼å¤„ç†
            if (navigator.userAgent.match(/(iPhone|iPod|Android|ios|iOS|iPad|Backerry|WebOS|Symbian|Windows Phone|Phone)/i)) {
                $('.shortcuts-hint').hide();
            }
        });
    </script>
</body>
</html>