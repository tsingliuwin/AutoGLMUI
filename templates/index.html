<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGLMUI - 智能任务助手</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.11.6/css/layui.css" integrity="sha512-dLA91UJdlyzyfUfYLOEnhXEXpY6U2ESWSSdLIvl85UKNUpXWHxJ+DWTZxVSqP2NIitTpxNPxBqC1JiOqynN1og==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.11.6/layui.js" integrity="sha512-BM5V+9an5QzWfkhrWFJbzkEj0V5glYZWgxY9o7S+c0JGAm6WzN67ZvyzxvTedzgW04QzMU6aSrh5VjCVCd035A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="layui-bg-gray">
    <div class="layui-container" style="width: 100%; max-width: 1200px; padding: 15px;">
        <!-- 顶部导航 -->
        <div class="layui-card" style="margin-bottom: 15px;">
            <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0; font-size: 24px; color: #1E9FFF;">
                    <i class="layui-icon layui-icon-voice"></i> AutoGLMUI
                </h1>
            </div>
        </div>

        <!-- 状态栏 -->
        <div class="layui-card" style="margin-bottom: 15px;">
            <div class="layui-card-body" style="text-align: center; padding: 15px;">
                <div class="layui-inline">
                    <span class="layui-badge layui-bg-green" id="statusIndicator" style="display: inline-flex; align-items: center; gap: 5px;">
                        <i class="layui-icon layui-icon-ok-circle"></i>
                        <span id="statusText">已连接</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- 示例任务折叠面板 -->
        <div class="layui-collapse" lay-accordion style="margin-bottom: 15px;" id="examplesCollapse">
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">
                    <i class="layui-icon layui-icon-template-1"></i> 示例任务
                    <span class="layui-badge layui-bg-blue" style="float: right; margin-right: 20px;">21个示例</span>
                </h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-row layui-col-space10" id="examplesList">
                        <!-- 示例1 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('打开微信发一条朋友圈：今天天气真不错！')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">打开微信发一条朋友圈：今天天气真不错！</span>
                            </button>
                        </div>
                        <!-- 示例2 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('打开抖音搜索猫咪视频')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">打开抖音搜索猫咪视频</span>
                            </button>
                        </div>
                        <!-- 示例3 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('打开淘宝给妈妈买生日礼物')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">打开淘宝给妈妈买生日礼物</span>
                            </button>
                        </div>
                        <!-- 示例4 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('打开百度地图搜索附近美食')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">打开百度地图搜索附近美食</span>
                            </button>
                        </div>
                        <!-- 示例5 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('打开网易云音乐播放周杰伦的歌')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">打开网易云音乐播放周杰伦的歌</span>
                            </button>
                        </div>
                        <!-- 示例6 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('打开知乎搜索如何学习编程')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">打开知乎搜索如何学习编程</span>
                            </button>
                        </div>
                        <!-- 示例7 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('打开美团找附近的咖啡厅')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">打开美团找附近的咖啡厅</span>
                            </button>
                        </div>
                        <!-- 示例8 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('打开B站搜索科技区最新视频')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">打开B站搜索科技区最新视频</span>
                            </button>
                        </div>
                        <!-- 更多示例默认隐藏 -->
                        <!-- 示例9 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('去喜马拉雅寻找关于个人成长的有声书，挑选评价最好的一本开始播放')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">去喜马拉雅寻找关于个人成长的有声书，挑选评价最好的一本开始播放</span>
                            </button>
                        </div>
                        <!-- 示例10 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('QQ音乐播放《来财》')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">QQ音乐播放《来财》</span>
                            </button>
                        </div>
                        <!-- 示例11 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('用值得买看看肯德基有什么优惠')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">用值得买看看肯德基有什么优惠</span>
                            </button>
                        </div>
                        <!-- 示例12 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('帮我在携程找个去东京的旅行团')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">帮我在携程找个去东京的旅行团</span>
                            </button>
                        </div>
                        <!-- 示例13 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('发一条小红书说：这是AutoGLM自动帮我发的小红书！')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">发一条小红书说：这是AutoGLM自动帮我发的小红书！</span>
                            </button>
                        </div>
                        <!-- 示例14 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('去红果短剧上，播放一个重生题材的短剧')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">去红果短剧上，播放一个重生题材的短剧</span>
                            </button>
                        </div>
                        <!-- 示例15 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('去小红书客观总结下autoglm的评价')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">去小红书客观总结下autoglm的评价</span>
                            </button>
                        </div>
                        <!-- 示例16 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('在携程上搜索上海外滩附近的五星级酒店，预订一间明晚入住的大床房')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">在携程上搜索上海外滩附近的五星级酒店，预订一间明晚入住的大床房</span>
                            </button>
                        </div>
                        <!-- 示例17 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('在小红书搜索北京旅游攻略')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">在小红书搜索北京旅游攻略</span>
                            </button>
                        </div>
                        <!-- 示例18 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('饿了么帮我订杯瑞幸的生椰拿铁')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">饿了么帮我订杯瑞幸的生椰拿铁</span>
                            </button>
                        </div>
                        <!-- 示例19 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('帮我用高德地图看一下距离五道口最近的农业银行的营业时间')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">帮我用高德地图看一下距离五道口最近的农业银行的营业时间</span>
                            </button>
                        </div>
                        <!-- 示例20 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('腾讯视频播放《无相之城》第2集')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">腾讯视频播放《无相之城》第2集</span>
                            </button>
                        </div>
                        <!-- 示例21 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('打开微博查看热搜榜')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">打开微博查看热搜榜</span>
                            </button>
                        </div>
                    </div>
                    <div class="layui-text-center" style="margin-top: 10px;">
                        <button class="layui-btn layui-btn-xs layui-btn-primary" id="loadMoreBtn">
                            <i class="layui-icon layui-icon-down"></i> 展开更多
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务输入区 -->
        <div class="layui-card" style="margin-bottom: 15px;">
            <div class="layui-card-body">
                <form class="layui-form" action="">
                    <div class="layui-form-item layui-form-text">
                        <div class="layui-input-block" style="margin-left: 0;">
                            <textarea id="taskInput" placeholder="请输入您的任务...（按 Ctrl+Enter 发送）"
                                class="layui-textarea" style="min-height: 100px; resize: vertical;"></textarea>
                            <div style="text-align: right; margin-top: 5px; font-size: 12px; color: #999;">
                                <span id="charCount">0</span>/1000
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item" style="text-align: center; margin-bottom: 0;">
                        <button type="button" class="layui-btn" id="sendButton" lay-submit lay-filter="taskForm">
                            <i class="layui-icon layui-icon-release"></i> 发送任务
                        </button>
                        <button type="button" class="layui-btn layui-btn-primary" id="clearButton">
                            <i class="layui-icon layui-icon-delete"></i> 清空记录
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 响应记录 -->
        <div class="layui-card">
            <div class="layui-card-header">
                <span style="font-weight: bold;">
                    <i class="layui-icon layui-icon-file-b"></i> 响应记录
                </span>
                <span class="layui-badge layui-bg-gray" id="responseCount" style="float: right;">0 条记录</span>
            </div>
            <div class="layui-card-body">
                <div id="responseList" style="max-height: 500px; overflow-y: auto;">
                    <div class="layui-text-center" id="emptyState">
                        <i class="layui-icon layui-icon-face-surprised" style="font-size: 64px; color: #999;"></i>
                        <p style="color: #999; margin-top: 10px;">暂无响应记录</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快捷键提示 -->
        <div class="layui-text-center" style="margin-top: 15px; color: #999; font-size: 13px;">
            <span class="layui-badge layui-bg-gray">Ctrl</span> +
            <span class="layui-badge layui-bg-gray">Enter</span>
            快速发送任务
        </div>
    </div>

    <!-- Toast容器 -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // 展开更多示例功能
        document.addEventListener('DOMContentLoaded', function() {
            var loadMoreBtn = document.getElementById('loadMoreBtn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var isExpanded = this.innerHTML.includes('收起示例');
                    var moreExamples = document.querySelectorAll('.more-example');

                    if (isExpanded) {
                        // 收起
                        moreExamples.forEach(function(el) {
                            el.style.display = 'none';
                        });
                        this.innerHTML = '<i class="layui-icon layui-icon-down"></i> 展开更多';
                    } else {
                        // 展开
                        moreExamples.forEach(function(el) {
                            el.style.setProperty('display', 'block', 'important');
                        });
                        this.innerHTML = '<i class="layui-icon layui-icon-up"></i> 收起示例';
                    }
                });
            }
        });

        layui.use(['layer', 'form', 'element', 'util'], function(){
            var layer = layui.layer;
            var form = layui.form;
            var element = layui.element;
            var util = layui.util;
            var $ = layui.$;

  
            // 选择示例
            window.selectExample = function(example) {
                $('#taskInput').val(example);
                $('#charCount').text(example.length);
                layer.msg('已填入示例任务', {icon: 1, time: 1000});
                $('#taskInput').focus();

                // 如果当前是展开状态，自动收起
                const btn = $('#loadMoreBtn');
                const isExpanded = btn.html().includes('收起示例');
                if (isExpanded) {
                    setTimeout(function() {
                        $('.more-example').hide();
                        btn.html('<i class="layui-icon layui-icon-down"></i> 展开更多');
                    }, 200);
                }

                // 移动端自动收起键盘
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    $('#taskInput').blur();
                }
            };

        
    
            let taskId = 0;
            let responseCount = 0;

            // 文本框字符计数
            $('#taskInput').on('input', function(){
                const length = $(this).val().length;
                $('#charCount').text(length);
                if (length > 1000) {
                    $(this).val($(this).val().substring(0, 1000));
                    $('#charCount').text(1000);
                }
            });

            // 发送任务
            window.sendTask = function() {
                const task = $('#taskInput').val().trim();
                if (!task) {
                    layer.msg('请输入任务内容', {icon: 2});
                    return;
                }

                // 显示加载
                const loadIndex = layer.load(2, {shade: [0.1, '#fff']});

                // 创建新的响应项
                const responseList = $('#responseList');
                const emptyState = $('#emptyState');

                if (responseCount === 0) {
                    responseList.empty();
                    responseList.addClass('layui-timeline');
                }

                const time = util.toDateString(new Date(), 'yyyy-MM-dd HH:mm:ss');
                const responseId = ++taskId;

                const responseItem = $(`
                    <div class="layui-timeline-item" style="padding-bottom: 20px;">
                        <i class="layui-icon layui-timeline-axis layui-icon-loading-1" style="color: #1E9FFF;"></i>
                        <div class="layui-timeline-content layui-text">
                            <div class="layui-card">
                                <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="layui-badge layui-bg-blue" style="font-size: 12px;">任务 #${responseId}</span>
                                    <span style="color: #999; font-size: 12px;">${time}</span>
                                </div>
                                <div class="layui-card-body">
                                    <blockquote class="layui-elem-quote" style="margin-bottom: 10px;">
                                        <strong>任务:</strong> ${task}
                                    </blockquote>
                                    <div id="streaming-${responseId}" style="color: #666; line-height: 1.6;">
                                        <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="progress-${responseId}">
                                            <div class="layui-progress-bar" lay-percent="0%"></div>
                                        </div>
                                        <div style="margin-top: 10px; font-size: 14px; color: #999;">
                                            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 等待响应...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);

                responseItem.data('taskId', responseId);
                responseItem.data('task', task);
                responseList.prepend(responseItem);
                emptyState.hide();
                responseCount++;
                updateResponseCount();

                // 初始化进度条
                element.render('progress');

                // 使用 HTTP Streaming
                fetch('/api/send-task-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ task: task })
                }).then(response => {
                    layer.close(loadIndex);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let progress = 0;
                    let buffer = '';

                    function processStream() {
                        return reader.read().then(({ done, value }) => {
                            if (done) {
                                // 流结束
                                document.querySelector(`#streaming-${responseId}`).innerHTML = `
                                    <div style="color: #999; font-size: 14px;">
                                        <i class="layui-icon layui-icon-ok-circle" style="color: #5FB878;"></i> 任务完成
                                    </div>
                                `;
                                return;
                            }

                            // 解码新的数据块
                            const chunk = decoder.decode(value, { stream: true });
                            buffer += chunk;

                            // 按行分割数据
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // 保留最后一个可能不完整的行

                            // 处理每一行
                            lines.forEach(line => {
                                if (line.trim()) {
                                    try {
                                        const data = JSON.parse(line);
                                        handleStreamingData(responseId, data, progress);

                                        // 更新进度
                                        if (data.type === 'response') {
                                            progress = Math.min(progress + 10, 90);
                                            element.progress('progress-' + responseId, progress + '%');
                                        }
                                    } catch (e) {
                                        console.error('Error parsing streaming data:', e, 'Raw data:', line);
                                    }
                                }
                            });

                            return processStream();
                        });
                    }

                    return processStream();
                }).catch(error => {
                    layer.close(loadIndex);
                    console.error('Streaming error:', error);
                    document.querySelector(`#streaming-${responseId}`).innerHTML = `
                        <div style="color: #FF5722; font-size: 14px;">
                            <i class="layui-icon layui-icon-close-fill"></i> 错误: ${error.message}
                        </div>
                    `;
                });

                $('#taskInput').val('');
                $('#charCount').text('0');
            };

            // 处理 streaming 数据
            function handleStreamingData(responseId, data, progress) {
                const container = document.querySelector(`#streaming-${responseId}`);
                if (!container) return;

                if (data.type === 'sent') {
                    container.innerHTML = `
                        <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="progress-${responseId}">
                            <div class="layui-progress-bar" lay-percent="0%"></div>
                        </div>
                        <div style="margin-top: 10px; font-size: 14px; color: #999;">
                            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 任务已发送，等待响应...
                        </div>
                    `;
                    element.render('progress');
                } else if (data.type === 'response') {
                    const msgType = data.data.msg_type || 'unknown';
                    const parsedData = data.data.parsed_data;

                    // 创建或获取响应内容容器
                    const responseDiv = container.querySelector('.response-content') || document.createElement('div');
                    responseDiv.className = 'response-content';
                    responseDiv.style.marginTop = '10px';
                    responseDiv.style.padding = '10px';
                    responseDiv.style.backgroundColor = '#f8f8f8';
                    responseDiv.style.borderRadius = '4px';
                    responseDiv.style.fontSize = '14px';
                    responseDiv.style.whiteSpace = 'pre-wrap';
                    responseDiv.style.maxHeight = '400px';
                    responseDiv.style.overflowY = 'auto';

                    // 根据消息类型格式化显示
                    let displayContent = '';
                    const timestamp = new Date(data.data.timestamp).toLocaleTimeString();

                    if (msgType === 'server_init') {
                        displayContent = `[${timestamp}] 🔧 系统初始化完成\n`;
                    } else if (msgType === 'server_session') {
                        displayContent = `[${timestamp}] 🔒 会话已建立\n`;
                    } else if (msgType === 'agent_response') {
                        const content = parsedData?.data?.content || parsedData?.content || '代理响应';
                        displayContent = `[${timestamp}] 🤖 代理响应:\n${content}\n\n`;
                    } else if (msgType === 'task_result') {
                        const result = parsedData?.data?.result || parsedData?.result || '任务完成';
                        displayContent = `[${timestamp}] ✅ 任务结果:\n${result}\n\n`;
                    } else if (msgType === 'task_status') {
                        const status = parsedData?.data?.status || '状态更新';
                        displayContent = `[${timestamp}] 📊 任务状态: ${status}\n`;
                    } else if (msgType === 'error') {
                        const errorMsg = parsedData?.data?.error || parsedData?.error || '发生错误';
                        displayContent = `[${timestamp}] ❌ 错误: ${errorMsg}\n`;
                    } else {
                        // 显示原始消息或解析后的内容
                        const message = parsedData?.data?.message || parsedData?.message || data.data.message;
                        if (message) {
                            displayContent = `[${timestamp}] 📨 ${message}\n\n`;
                        }
                    }

                    // 追加到现有内容
                    if (displayContent) {
                        responseDiv.textContent += displayContent;
                    }

                    if (!container.querySelector('.response-content')) {
                        container.appendChild(responseDiv);
                    }

                    // 自动滚动到底部
                    responseDiv.scrollTop = responseDiv.scrollHeight;
                } else if (data.type === 'error') {
                    container.innerHTML = `
                        <div style="color: #FF5722; font-size: 14px;">
                            <i class="layui-icon layui-icon-close-fill"></i> 错误: ${data.message}
                        </div>
                    `;
                } else if (data.type === 'complete') {
                    element.progress('progress-' + responseId, '100%');

                    // 更新进度条显示
                    const progressBar = container.querySelector('.layui-progress');
                    if (progressBar) {
                        progressBar.style.display = 'none';
                    }

                    // 更新状态图标
                    const statusIcon = container.querySelector('.layui-icon-loading');
                    if (statusIcon) {
                        statusIcon.className = 'layui-icon layui-icon-ok-circle';
                        statusIcon.style.color = '#5FB878';
                        statusIcon.classList.remove('layui-anim', 'layui-anim-rotate', 'layui-anim-loop');
                    }

                    // 添加完成信息
                    const completeMsg = data.response_count ?
                        `任务完成 (共收到 ${data.response_count} 条响应)` :
                        '任务完成';

                    const statusDiv = container.querySelector('.status-text') || document.createElement('div');
                    statusDiv.className = 'status-text';
                    statusDiv.style.marginTop = '10px';
                    statusDiv.style.fontSize = '14px';
                    statusDiv.style.color = '#5FB878';
                    statusDiv.innerHTML = `<i class="layui-icon layui-icon-ok-circle"></i> ${completeMsg}`;

                    if (!container.querySelector('.status-text')) {
                        container.appendChild(statusDiv);
                    }
                }
            }

            // 显示响应
            function showResponse(task, response, timestamp) {
                const responseList = $('#responseList');
                const emptyState = $('#emptyState');

                const isSuccess = response.includes('任务已发送');
                const statusClass = isSuccess ? 'layui-badge layui-bg-green' : 'layui-badge layui-bg-red';
                const statusIcon = isSuccess ? 'layui-icon-ok-circle' : 'layui-icon-close-fill';

                const time = util.toDateString(new Date(timestamp), 'yyyy-MM-dd HH:mm:ss');
                const responseId = ++taskId;

                const responseItem = $(`
                    <div class="layui-timeline-item" style="padding-bottom: 20px;">
                        <i class="layui-icon layui-timeline-axis ${statusIcon}" style="color: ${isSuccess ? '#5FB878' : '#FF5722'};"></i>
                        <div class="layui-timeline-content layui-text">
                            <div class="layui-card">
                                <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="${statusClass}" style="font-size: 12px;">任务 #${responseId}</span>
                                    <span style="color: #999; font-size: 12px;">${time}</span>
                                </div>
                                <div class="layui-card-body">
                                    <blockquote class="layui-elem-quote" style="margin-bottom: 10px;">
                                        <strong>任务:</strong> ${task}
                                    </blockquote>
                                    <div style="color: #666; line-height: 1.6;">
                                        ${response}
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="copyResponse(${responseId})">
                                            <i class="layui-icon layui-icon-file"></i> 复制
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);

                responseItem.data('taskId', responseId);
                responseItem.data('task', task);
                responseItem.data('response', response);

                if (responseCount === 0) {
                    responseList.empty();
                    responseList.addClass('layui-timeline');
                }

                responseList.prepend(responseItem);
                emptyState.hide();

                responseCount++;
                updateResponseCount();
            }

            // 复制响应
            window.copyResponse = function(id) {
                const responseItem = $(`[data-task-id="${id}"]`);
                if (responseItem.length) {
                    const task = responseItem.data('task');
                    const response = responseItem.data('response');
                    const text = `任务: ${task}\n响应: ${response}`;

                    navigator.clipboard.writeText(text).then(function() {
                        layer.msg('已复制到剪贴板', {icon: 1});
                    }).catch(function() {
                        layer.msg('复制失败', {icon: 2});
                    });
                }
            };

            // 清空响应
            window.clearResponses = function() {
                if (responseCount === 0) {
                    layer.msg('没有记录需要清空', {icon: 0});
                    return;
                }

                layer.confirm('确定要清空所有响应记录吗？', {icon: 3, title: '提示'}, function(index){
                    $('#responseList').empty().removeClass('layui-timeline');
                    $('#emptyState').show();
                    responseCount = 0;
                    taskId = 0;
                    updateResponseCount();
                    layer.close(index);
                    layer.msg('已清空所有记录', {icon: 1});
                });
            };

            // 更新响应计数
            function updateResponseCount() {
                $('#responseCount').text(`${responseCount} 条记录`);
            }

            // 绑定按钮事件
            $('#sendButton').on('click', sendTask);
            $('#clearButton').on('click', clearResponses);

            // Ctrl+Enter 发送
            $('#taskInput').on('keydown', function(e){
                if (e.ctrlKey && e.keyCode === 13) {
                    e.preventDefault();
                    sendTask();
                }
            });

            // 自动更新状态
            function updateStatus() {
                $.get('/api/status', function(data){
                    const statusIndicator = $('#statusIndicator');
                    const statusText = $('#statusText');

                    if (data.connected) {
                        statusIndicator.removeClass('layui-bg-red').addClass('layui-bg-green');
                        statusIndicator.html('<i class="layui-icon layui-icon-ok-circle"></i> <span>已连接</span>');
                    } else {
                        statusIndicator.removeClass('layui-bg-green').addClass('layui-bg-red');
                        statusIndicator.html('<i class="layui-icon layui-icon-close-fill"></i> <span>未连接</span>');
                    }
                }).fail(function(){
                    const statusIndicator = $('#statusIndicator');
                    statusIndicator.removeClass('layui-bg-green').addClass('layui-bg-red');
                    statusIndicator.html('<i class="layui-icon layui-icon-close-fill"></i> <span>未连接</span>');
                });
            }

            // 每5秒更新状态
            setInterval(updateStatus, 5000);
            updateStatus();

            // 响应式处理
            if (navigator.userAgent.match(/(iPhone|iPod|Android|ios|iOS|iPad|Backerry|WebOS|Symbian|Windows Phone|Phone)/i)) {
                $('.shortcuts-hint').hide();
            }
        });
    </script>
</body>
</html>