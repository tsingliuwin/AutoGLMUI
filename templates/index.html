<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGLMUI - æ™ºèƒ½ä»»åŠ¡åŠ©æ‰‹</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.11.6/css/layui.css" integrity="sha512-dLA91UJdlyzyfUfYLOEnhXEXpY6U2ESWSSdLIvl85UKNUpXWHxJ+DWTZxVSqP2NIitTpxNPxBqC1JiOqynN1og==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.11.6/layui.js" integrity="sha512-BM5V+9an5QzWfkhrWFJbzkEj0V5glYZWgxY9o7S+c0JGAm6WzN67ZvyzxvTedzgW04QzMU6aSrh5VjCVCd035A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="layui-bg-gray">
    <div class="layui-container" style="width: 100%; max-width: 1200px; padding: 15px;">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="layui-card" style="margin-bottom: 15px;">
            <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0; font-size: 24px; color: #1E9FFF;">
                    <i class="layui-icon layui-icon-voice"></i> AutoGLMUI
                </h1>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="layui-card" style="margin-bottom: 15px;">
            <div class="layui-card-body" style="text-align: center; padding: 15px;">
                <div class="layui-inline">
                    <span class="layui-badge layui-bg-green" id="statusIndicator" style="display: inline-flex; align-items: center; gap: 5px;">
                        <i class="layui-icon layui-icon-ok-circle"></i>
                        <span id="statusText">å·²è¿æ¥</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- ç¤ºä¾‹ä»»åŠ¡æŠ˜å é¢æ¿ -->
        <div class="layui-collapse" lay-accordion style="margin-bottom: 15px;" id="examplesCollapse">
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">
                    <i class="layui-icon layui-icon-template-1"></i> ç¤ºä¾‹ä»»åŠ¡
                    <span class="layui-badge layui-bg-blue" style="float: right; margin-right: 20px;">21ä¸ªç¤ºä¾‹</span>
                </h2>
                <div class="layui-colla-content layui-show">
                    <div class="layui-row layui-col-space10" id="examplesList">
                        <!-- ç¤ºä¾‹1 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€å¾®ä¿¡å‘ä¸€æ¡æœ‹å‹åœˆï¼šä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€å¾®ä¿¡å‘ä¸€æ¡æœ‹å‹åœˆï¼šä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹2 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€æŠ–éŸ³æœç´¢çŒ«å’ªè§†é¢‘')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€æŠ–éŸ³æœç´¢çŒ«å’ªè§†é¢‘</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹3 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€æ·˜å®ç»™å¦ˆå¦ˆä¹°ç”Ÿæ—¥ç¤¼ç‰©')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€æ·˜å®ç»™å¦ˆå¦ˆä¹°ç”Ÿæ—¥ç¤¼ç‰©</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹4 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€ç™¾åº¦åœ°å›¾æœç´¢é™„è¿‘ç¾é£Ÿ')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€ç™¾åº¦åœ°å›¾æœç´¢é™„è¿‘ç¾é£Ÿ</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹5 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å‘¨æ°ä¼¦çš„æ­Œ')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å‘¨æ°ä¼¦çš„æ­Œ</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹6 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€çŸ¥ä¹æœç´¢å¦‚ä½•å­¦ä¹ ç¼–ç¨‹')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€çŸ¥ä¹æœç´¢å¦‚ä½•å­¦ä¹ ç¼–ç¨‹</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹7 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€ç¾å›¢æ‰¾é™„è¿‘çš„å’–å•¡å…')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€ç¾å›¢æ‰¾é™„è¿‘çš„å’–å•¡å…</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹8 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€Bç«™æœç´¢ç§‘æŠ€åŒºæœ€æ–°è§†é¢‘')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€Bç«™æœç´¢ç§‘æŠ€åŒºæœ€æ–°è§†é¢‘</span>
                            </button>
                        </div>
                        <!-- æ›´å¤šç¤ºä¾‹é»˜è®¤éšè— -->
                        <!-- ç¤ºä¾‹9 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å»å–œé©¬æ‹‰é›…å¯»æ‰¾å…³äºä¸ªäººæˆé•¿çš„æœ‰å£°ä¹¦ï¼ŒæŒ‘é€‰è¯„ä»·æœ€å¥½çš„ä¸€æœ¬å¼€å§‹æ’­æ”¾')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å»å–œé©¬æ‹‰é›…å¯»æ‰¾å…³äºä¸ªäººæˆé•¿çš„æœ‰å£°ä¹¦ï¼ŒæŒ‘é€‰è¯„ä»·æœ€å¥½çš„ä¸€æœ¬å¼€å§‹æ’­æ”¾</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹10 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('QQéŸ³ä¹æ’­æ”¾ã€Šæ¥è´¢ã€‹')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">QQéŸ³ä¹æ’­æ”¾ã€Šæ¥è´¢ã€‹</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹11 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('ç”¨å€¼å¾—ä¹°çœ‹çœ‹è‚¯å¾·åŸºæœ‰ä»€ä¹ˆä¼˜æƒ ')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">ç”¨å€¼å¾—ä¹°çœ‹çœ‹è‚¯å¾·åŸºæœ‰ä»€ä¹ˆä¼˜æƒ </span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹12 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å¸®æˆ‘åœ¨æºç¨‹æ‰¾ä¸ªå»ä¸œäº¬çš„æ—…è¡Œå›¢')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å¸®æˆ‘åœ¨æºç¨‹æ‰¾ä¸ªå»ä¸œäº¬çš„æ—…è¡Œå›¢</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹13 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å‘ä¸€æ¡å°çº¢ä¹¦è¯´ï¼šè¿™æ˜¯AutoGLMè‡ªåŠ¨å¸®æˆ‘å‘çš„å°çº¢ä¹¦ï¼')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å‘ä¸€æ¡å°çº¢ä¹¦è¯´ï¼šè¿™æ˜¯AutoGLMè‡ªåŠ¨å¸®æˆ‘å‘çš„å°çº¢ä¹¦ï¼</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹14 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å»çº¢æœçŸ­å‰§ä¸Šï¼Œæ’­æ”¾ä¸€ä¸ªé‡ç”Ÿé¢˜æçš„çŸ­å‰§')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å»çº¢æœçŸ­å‰§ä¸Šï¼Œæ’­æ”¾ä¸€ä¸ªé‡ç”Ÿé¢˜æçš„çŸ­å‰§</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹15 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å»å°çº¢ä¹¦å®¢è§‚æ€»ç»“ä¸‹autoglmçš„è¯„ä»·')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å»å°çº¢ä¹¦å®¢è§‚æ€»ç»“ä¸‹autoglmçš„è¯„ä»·</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹16 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('åœ¨æºç¨‹ä¸Šæœç´¢ä¸Šæµ·å¤–æ»©é™„è¿‘çš„äº”æ˜Ÿçº§é…’åº—ï¼Œé¢„è®¢ä¸€é—´æ˜æ™šå…¥ä½çš„å¤§åºŠæˆ¿')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">åœ¨æºç¨‹ä¸Šæœç´¢ä¸Šæµ·å¤–æ»©é™„è¿‘çš„äº”æ˜Ÿçº§é…’åº—ï¼Œé¢„è®¢ä¸€é—´æ˜æ™šå…¥ä½çš„å¤§åºŠæˆ¿</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹17 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('åœ¨å°çº¢ä¹¦æœç´¢åŒ—äº¬æ—…æ¸¸æ”»ç•¥')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">åœ¨å°çº¢ä¹¦æœç´¢åŒ—äº¬æ—…æ¸¸æ”»ç•¥</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹18 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('é¥¿äº†ä¹ˆå¸®æˆ‘è®¢æ¯ç‘å¹¸çš„ç”Ÿæ¤°æ‹¿é“')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">é¥¿äº†ä¹ˆå¸®æˆ‘è®¢æ¯ç‘å¹¸çš„ç”Ÿæ¤°æ‹¿é“</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹19 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('å¸®æˆ‘ç”¨é«˜å¾·åœ°å›¾çœ‹ä¸€ä¸‹è·ç¦»äº”é“å£æœ€è¿‘çš„å†œä¸šé“¶è¡Œçš„è¥ä¸šæ—¶é—´')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">å¸®æˆ‘ç”¨é«˜å¾·åœ°å›¾çœ‹ä¸€ä¸‹è·ç¦»äº”é“å£æœ€è¿‘çš„å†œä¸šé“¶è¡Œçš„è¥ä¸šæ—¶é—´</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹20 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('è…¾è®¯è§†é¢‘æ’­æ”¾ã€Šæ— ç›¸ä¹‹åŸã€‹ç¬¬2é›†')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">è…¾è®¯è§†é¢‘æ’­æ”¾ã€Šæ— ç›¸ä¹‹åŸã€‹ç¬¬2é›†</span>
                            </button>
                        </div>
                        <!-- ç¤ºä¾‹21 -->
                        <div class="layui-col-xs12 layui-col-sm6 layui-col-md3 example-item more-example" style="display: none;">
                            <button class="layui-btn layui-btn-primary layui-btn-fluid example-card" onclick="selectExample('æ‰“å¼€å¾®åšæŸ¥çœ‹çƒ­æœæ¦œ')">
                                <i class="layui-icon layui-icon-right"></i> <span class="card-content">æ‰“å¼€å¾®åšæŸ¥çœ‹çƒ­æœæ¦œ</span>
                            </button>
                        </div>
                    </div>
                    <div class="layui-text-center" style="margin-top: 10px;">
                        <button class="layui-btn layui-btn-xs layui-btn-primary" id="loadMoreBtn">
                            <i class="layui-icon layui-icon-down"></i> å±•å¼€æ›´å¤š
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡è¾“å…¥åŒº -->
        <div class="layui-card" style="margin-bottom: 15px;">
            <div class="layui-card-body">
                <form class="layui-form" action="">
                    <div class="layui-form-item layui-form-text">
                        <div class="layui-input-block" style="margin-left: 0;">
                            <textarea id="taskInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ä»»åŠ¡...ï¼ˆæŒ‰ Ctrl+Enter å‘é€ï¼‰"
                                class="layui-textarea" style="min-height: 100px; resize: vertical;"></textarea>
                            <div style="text-align: right; margin-top: 5px; font-size: 12px; color: #999;">
                                <span id="charCount">0</span>/1000
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item" style="text-align: center; margin-bottom: 0;">
                        <button type="button" class="layui-btn" id="sendButton" lay-submit lay-filter="taskForm">
                            <i class="layui-icon layui-icon-release"></i> å‘é€ä»»åŠ¡
                        </button>
                        <button type="button" class="layui-btn layui-btn-primary" id="clearButton">
                            <i class="layui-icon layui-icon-delete"></i> æ¸…ç©ºè®°å½•
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- å“åº”è®°å½• -->
        <div class="layui-card">
            <div class="layui-card-header">
                <span style="font-weight: bold;">
                    <i class="layui-icon layui-icon-file-b"></i> å“åº”è®°å½•
                </span>
                <span class="layui-badge layui-bg-gray" id="responseCount" style="float: right;">0 æ¡è®°å½•</span>
            </div>
            <div class="layui-card-body">
                <div id="responseList" style="max-height: 500px; overflow-y: auto;">
                    <div class="layui-text-center" id="emptyState">
                        <i class="layui-icon layui-icon-face-surprised" style="font-size: 64px; color: #999;"></i>
                        <p style="color: #999; margin-top: 10px;">æš‚æ— å“åº”è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿«æ·é”®æç¤º -->
        <div class="layui-text-center" style="margin-top: 15px; color: #999; font-size: 13px;">
            <span class="layui-badge layui-bg-gray">Ctrl</span> +
            <span class="layui-badge layui-bg-gray">Enter</span>
            å¿«é€Ÿå‘é€ä»»åŠ¡
        </div>
    </div>

    <!-- Toastå®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // å±•å¼€æ›´å¤šç¤ºä¾‹åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            var loadMoreBtn = document.getElementById('loadMoreBtn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var isExpanded = this.innerHTML.includes('æ”¶èµ·ç¤ºä¾‹');
                    var moreExamples = document.querySelectorAll('.more-example');

                    if (isExpanded) {
                        // æ”¶èµ·
                        moreExamples.forEach(function(el) {
                            el.style.display = 'none';
                        });
                        this.innerHTML = '<i class="layui-icon layui-icon-down"></i> å±•å¼€æ›´å¤š';
                    } else {
                        // å±•å¼€
                        moreExamples.forEach(function(el) {
                            el.style.setProperty('display', 'block', 'important');
                        });
                        this.innerHTML = '<i class="layui-icon layui-icon-up"></i> æ”¶èµ·ç¤ºä¾‹';
                    }
                });
            }
        });

        layui.use(['layer', 'form', 'element', 'util'], function(){
            var layer = layui.layer;
            var form = layui.form;
            var element = layui.element;
            var util = layui.util;
            var $ = layui.$;

  
            // é€‰æ‹©ç¤ºä¾‹
            window.selectExample = function(example) {
                $('#taskInput').val(example);
                $('#charCount').text(example.length);
                layer.msg('å·²å¡«å…¥ç¤ºä¾‹ä»»åŠ¡', {icon: 1, time: 1000});
                $('#taskInput').focus();

                // å¦‚æœå½“å‰æ˜¯å±•å¼€çŠ¶æ€ï¼Œè‡ªåŠ¨æ”¶èµ·
                const btn = $('#loadMoreBtn');
                const isExpanded = btn.html().includes('æ”¶èµ·ç¤ºä¾‹');
                if (isExpanded) {
                    setTimeout(function() {
                        $('.more-example').hide();
                        btn.html('<i class="layui-icon layui-icon-down"></i> å±•å¼€æ›´å¤š');
                    }, 200);
                }

                // ç§»åŠ¨ç«¯è‡ªåŠ¨æ”¶èµ·é”®ç›˜
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    $('#taskInput').blur();
                }
            };

        
    
            let taskId = 0;
            let responseCount = 0;

            // æ–‡æœ¬æ¡†å­—ç¬¦è®¡æ•°
            $('#taskInput').on('input', function(){
                const length = $(this).val().length;
                $('#charCount').text(length);
                if (length > 1000) {
                    $(this).val($(this).val().substring(0, 1000));
                    $('#charCount').text(1000);
                }
            });

            // å‘é€ä»»åŠ¡
            window.sendTask = function() {
                const task = $('#taskInput').val().trim();
                if (!task) {
                    layer.msg('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹', {icon: 2});
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½
                const loadIndex = layer.load(2, {shade: [0.1, '#fff']});

                // åˆ›å»ºæ–°çš„å“åº”é¡¹
                const responseList = $('#responseList');
                const emptyState = $('#emptyState');

                if (responseCount === 0) {
                    responseList.empty();
                    responseList.addClass('layui-timeline');
                }

                const time = util.toDateString(new Date(), 'yyyy-MM-dd HH:mm:ss');
                const responseId = ++taskId;

                const responseItem = $(`
                    <div class="layui-timeline-item" style="padding-bottom: 20px;">
                        <i class="layui-icon layui-timeline-axis layui-icon-loading-1" style="color: #1E9FFF;"></i>
                        <div class="layui-timeline-content layui-text">
                            <div class="layui-card">
                                <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="layui-badge layui-bg-blue" style="font-size: 12px;">ä»»åŠ¡ #${responseId}</span>
                                    <span style="color: #999; font-size: 12px;">${time}</span>
                                </div>
                                <div class="layui-card-body">
                                    <blockquote class="layui-elem-quote" style="margin-bottom: 10px;">
                                        <strong>ä»»åŠ¡:</strong> ${task}
                                    </blockquote>
                                    <div id="streaming-${responseId}" style="color: #666; line-height: 1.6;">
                                        <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="progress-${responseId}">
                                            <div class="layui-progress-bar" lay-percent="0%"></div>
                                        </div>
                                        <div style="margin-top: 10px; font-size: 14px; color: #999;">
                                            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> ç­‰å¾…å“åº”...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);

                responseItem.data('taskId', responseId);
                responseItem.data('task', task);
                responseList.prepend(responseItem);
                emptyState.hide();
                responseCount++;
                updateResponseCount();

                // åˆå§‹åŒ–è¿›åº¦æ¡
                element.render('progress');

                // ä½¿ç”¨ HTTP Streaming
                fetch('/api/send-task-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ task: task })
                }).then(response => {
                    layer.close(loadIndex);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let progress = 0;
                    let buffer = '';

                    function processStream() {
                        return reader.read().then(({ done, value }) => {
                            if (done) {
                                // æµç»“æŸ
                                document.querySelector(`#streaming-${responseId}`).innerHTML = `
                                    <div style="color: #999; font-size: 14px;">
                                        <i class="layui-icon layui-icon-ok-circle" style="color: #5FB878;"></i> ä»»åŠ¡å®Œæˆ
                                    </div>
                                `;
                                return;
                            }

                            // è§£ç æ–°çš„æ•°æ®å—
                            const chunk = decoder.decode(value, { stream: true });
                            buffer += chunk;

                            // æŒ‰è¡Œåˆ†å‰²æ•°æ®
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„è¡Œ

                            // å¤„ç†æ¯ä¸€è¡Œ
                            lines.forEach(line => {
                                if (line.trim()) {
                                    try {
                                        const data = JSON.parse(line);
                                        handleStreamingData(responseId, data, progress);

                                        // æ›´æ–°è¿›åº¦
                                        if (data.type === 'response') {
                                            progress = Math.min(progress + 10, 90);
                                            element.progress('progress-' + responseId, progress + '%');
                                        }
                                    } catch (e) {
                                        console.error('Error parsing streaming data:', e, 'Raw data:', line);
                                    }
                                }
                            });

                            return processStream();
                        });
                    }

                    return processStream();
                }).catch(error => {
                    layer.close(loadIndex);
                    console.error('Streaming error:', error);
                    document.querySelector(`#streaming-${responseId}`).innerHTML = `
                        <div style="color: #FF5722; font-size: 14px;">
                            <i class="layui-icon layui-icon-close-fill"></i> é”™è¯¯: ${error.message}
                        </div>
                    `;
                });

                $('#taskInput').val('');
                $('#charCount').text('0');
            };

            // å¤„ç† streaming æ•°æ®
            function handleStreamingData(responseId, data, progress) {
                const container = document.querySelector(`#streaming-${responseId}`);
                if (!container) return;

                if (data.type === 'sent') {
                    container.innerHTML = `
                        <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="progress-${responseId}">
                            <div class="layui-progress-bar" lay-percent="0%"></div>
                        </div>
                        <div style="margin-top: 10px; font-size: 14px; color: #999;">
                            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> ä»»åŠ¡å·²å‘é€ï¼Œç­‰å¾…å“åº”...
                        </div>
                    `;
                    element.render('progress');
                } else if (data.type === 'response') {
                    const msgType = data.data.msg_type || 'unknown';
                    const parsedData = data.data.parsed_data;

                    // åˆ›å»ºæˆ–è·å–å“åº”å†…å®¹å®¹å™¨
                    const responseDiv = container.querySelector('.response-content') || document.createElement('div');
                    responseDiv.className = 'response-content';
                    responseDiv.style.marginTop = '10px';
                    responseDiv.style.padding = '10px';
                    responseDiv.style.backgroundColor = '#f8f8f8';
                    responseDiv.style.borderRadius = '4px';
                    responseDiv.style.fontSize = '14px';
                    responseDiv.style.whiteSpace = 'pre-wrap';
                    responseDiv.style.maxHeight = '400px';
                    responseDiv.style.overflowY = 'auto';

                    // æ ¹æ®æ¶ˆæ¯ç±»å‹æ ¼å¼åŒ–æ˜¾ç¤º
                    let displayContent = '';
                    const timestamp = new Date(data.data.timestamp).toLocaleTimeString();

                    if (msgType === 'server_init') {
                        displayContent = `[${timestamp}] ğŸ”§ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ\n`;
                    } else if (msgType === 'server_session') {
                        displayContent = `[${timestamp}] ğŸ”’ ä¼šè¯å·²å»ºç«‹\n`;
                    } else if (msgType === 'agent_response') {
                        const content = parsedData?.data?.content || parsedData?.content || 'ä»£ç†å“åº”';
                        displayContent = `[${timestamp}] ğŸ¤– ä»£ç†å“åº”:\n${content}\n\n`;
                    } else if (msgType === 'task_result') {
                        const result = parsedData?.data?.result || parsedData?.result || 'ä»»åŠ¡å®Œæˆ';
                        displayContent = `[${timestamp}] âœ… ä»»åŠ¡ç»“æœ:\n${result}\n\n`;
                    } else if (msgType === 'task_status') {
                        const status = parsedData?.data?.status || 'çŠ¶æ€æ›´æ–°';
                        displayContent = `[${timestamp}] ğŸ“Š ä»»åŠ¡çŠ¶æ€: ${status}\n`;
                    } else if (msgType === 'error') {
                        const errorMsg = parsedData?.data?.error || parsedData?.error || 'å‘ç”Ÿé”™è¯¯';
                        displayContent = `[${timestamp}] âŒ é”™è¯¯: ${errorMsg}\n`;
                    } else {
                        // æ˜¾ç¤ºåŸå§‹æ¶ˆæ¯æˆ–è§£æåçš„å†…å®¹
                        const message = parsedData?.data?.message || parsedData?.message || data.data.message;
                        if (message) {
                            displayContent = `[${timestamp}] ğŸ“¨ ${message}\n\n`;
                        }
                    }

                    // è¿½åŠ åˆ°ç°æœ‰å†…å®¹
                    if (displayContent) {
                        responseDiv.textContent += displayContent;
                    }

                    if (!container.querySelector('.response-content')) {
                        container.appendChild(responseDiv);
                    }

                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    responseDiv.scrollTop = responseDiv.scrollHeight;
                } else if (data.type === 'error') {
                    container.innerHTML = `
                        <div style="color: #FF5722; font-size: 14px;">
                            <i class="layui-icon layui-icon-close-fill"></i> é”™è¯¯: ${data.message}
                        </div>
                    `;
                } else if (data.type === 'complete') {
                    element.progress('progress-' + responseId, '100%');

                    // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
                    const progressBar = container.querySelector('.layui-progress');
                    if (progressBar) {
                        progressBar.style.display = 'none';
                    }

                    // æ›´æ–°çŠ¶æ€å›¾æ ‡
                    const statusIcon = container.querySelector('.layui-icon-loading');
                    if (statusIcon) {
                        statusIcon.className = 'layui-icon layui-icon-ok-circle';
                        statusIcon.style.color = '#5FB878';
                        statusIcon.classList.remove('layui-anim', 'layui-anim-rotate', 'layui-anim-loop');
                    }

                    // æ·»åŠ å®Œæˆä¿¡æ¯
                    const completeMsg = data.response_count ?
                        `ä»»åŠ¡å®Œæˆ (å…±æ”¶åˆ° ${data.response_count} æ¡å“åº”)` :
                        'ä»»åŠ¡å®Œæˆ';

                    const statusDiv = container.querySelector('.status-text') || document.createElement('div');
                    statusDiv.className = 'status-text';
                    statusDiv.style.marginTop = '10px';
                    statusDiv.style.fontSize = '14px';
                    statusDiv.style.color = '#5FB878';
                    statusDiv.innerHTML = `<i class="layui-icon layui-icon-ok-circle"></i> ${completeMsg}`;

                    if (!container.querySelector('.status-text')) {
                        container.appendChild(statusDiv);
                    }
                }
            }

            // æ˜¾ç¤ºå“åº”
            function showResponse(task, response, timestamp) {
                const responseList = $('#responseList');
                const emptyState = $('#emptyState');

                const isSuccess = response.includes('ä»»åŠ¡å·²å‘é€');
                const statusClass = isSuccess ? 'layui-badge layui-bg-green' : 'layui-badge layui-bg-red';
                const statusIcon = isSuccess ? 'layui-icon-ok-circle' : 'layui-icon-close-fill';

                const time = util.toDateString(new Date(timestamp), 'yyyy-MM-dd HH:mm:ss');
                const responseId = ++taskId;

                const responseItem = $(`
                    <div class="layui-timeline-item" style="padding-bottom: 20px;">
                        <i class="layui-icon layui-timeline-axis ${statusIcon}" style="color: ${isSuccess ? '#5FB878' : '#FF5722'};"></i>
                        <div class="layui-timeline-content layui-text">
                            <div class="layui-card">
                                <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="${statusClass}" style="font-size: 12px;">ä»»åŠ¡ #${responseId}</span>
                                    <span style="color: #999; font-size: 12px;">${time}</span>
                                </div>
                                <div class="layui-card-body">
                                    <blockquote class="layui-elem-quote" style="margin-bottom: 10px;">
                                        <strong>ä»»åŠ¡:</strong> ${task}
                                    </blockquote>
                                    <div style="color: #666; line-height: 1.6;">
                                        ${response}
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="copyResponse(${responseId})">
                                            <i class="layui-icon layui-icon-file"></i> å¤åˆ¶
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);

                responseItem.data('taskId', responseId);
                responseItem.data('task', task);
                responseItem.data('response', response);

                if (responseCount === 0) {
                    responseList.empty();
                    responseList.addClass('layui-timeline');
                }

                responseList.prepend(responseItem);
                emptyState.hide();

                responseCount++;
                updateResponseCount();
            }

            // å¤åˆ¶å“åº”
            window.copyResponse = function(id) {
                const responseItem = $(`[data-task-id="${id}"]`);
                if (responseItem.length) {
                    const task = responseItem.data('task');
                    const response = responseItem.data('response');
                    const text = `ä»»åŠ¡: ${task}\nå“åº”: ${response}`;

                    navigator.clipboard.writeText(text).then(function() {
                        layer.msg('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', {icon: 1});
                    }).catch(function() {
                        layer.msg('å¤åˆ¶å¤±è´¥', {icon: 2});
                    });
                }
            };

            // æ¸…ç©ºå“åº”
            window.clearResponses = function() {
                if (responseCount === 0) {
                    layer.msg('æ²¡æœ‰è®°å½•éœ€è¦æ¸…ç©º', {icon: 0});
                    return;
                }

                layer.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å“åº”è®°å½•å—ï¼Ÿ', {icon: 3, title: 'æç¤º'}, function(index){
                    $('#responseList').empty().removeClass('layui-timeline');
                    $('#emptyState').show();
                    responseCount = 0;
                    taskId = 0;
                    updateResponseCount();
                    layer.close(index);
                    layer.msg('å·²æ¸…ç©ºæ‰€æœ‰è®°å½•', {icon: 1});
                });
            };

            // æ›´æ–°å“åº”è®¡æ•°
            function updateResponseCount() {
                $('#responseCount').text(`${responseCount} æ¡è®°å½•`);
            }

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            $('#sendButton').on('click', sendTask);
            $('#clearButton').on('click', clearResponses);

            // Ctrl+Enter å‘é€
            $('#taskInput').on('keydown', function(e){
                if (e.ctrlKey && e.keyCode === 13) {
                    e.preventDefault();
                    sendTask();
                }
            });

            // è‡ªåŠ¨æ›´æ–°çŠ¶æ€
            function updateStatus() {
                $.get('/api/status', function(data){
                    const statusIndicator = $('#statusIndicator');
                    const statusText = $('#statusText');

                    if (data.connected) {
                        statusIndicator.removeClass('layui-bg-red').addClass('layui-bg-green');
                        statusIndicator.html('<i class="layui-icon layui-icon-ok-circle"></i> <span>å·²è¿æ¥</span>');
                    } else {
                        statusIndicator.removeClass('layui-bg-green').addClass('layui-bg-red');
                        statusIndicator.html('<i class="layui-icon layui-icon-close-fill"></i> <span>æœªè¿æ¥</span>');
                    }
                }).fail(function(){
                    const statusIndicator = $('#statusIndicator');
                    statusIndicator.removeClass('layui-bg-green').addClass('layui-bg-red');
                    statusIndicator.html('<i class="layui-icon layui-icon-close-fill"></i> <span>æœªè¿æ¥</span>');
                });
            }

            // æ¯5ç§’æ›´æ–°çŠ¶æ€
            setInterval(updateStatus, 5000);
            updateStatus();

            // å“åº”å¼å¤„ç†
            if (navigator.userAgent.match(/(iPhone|iPod|Android|ios|iOS|iPad|Backerry|WebOS|Symbian|Windows Phone|Phone)/i)) {
                $('.shortcuts-hint').hide();
            }
        });
    </script>
</body>
</html>